# Stock Analysis ç›‘æ§ç³»ç»Ÿ

æœ¬ç›®å½•åŒ…å« Prometheus å’Œ Grafana çš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºç›‘æ§ Stock Analysis é¡¹ç›®çš„æ€§èƒ½å’Œå¥åº·çŠ¶å†µã€‚

## ğŸ—ï¸ ç›‘æ§æ¶æ„

æœ¬é¡¹ç›®é‡‡ç”¨**æ··åˆç›‘æ§æ¶æ„**ï¼Œç»“åˆäº† Admin ç®¡ç†åå°çš„å®æ—¶å¥åº·æ£€æŸ¥å’Œä¸“ä¸šçš„ Grafana/Prometheus ç›‘æ§å·¥å…·ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç›‘æ§æ¶æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  Admin ç®¡ç†åå° (http://localhost:3002/monitor)         â”‚
â”‚  â”œâ”€â”€ å®æ—¶å¥åº·æ£€æŸ¥ï¼ˆæ•°æ®åº“ã€Redisã€æ ¸å¿ƒæœåŠ¡ï¼‰              â”‚
â”‚  â”œâ”€â”€ æœåŠ¡å“åº”æ—¶é—´å’Œæ€§èƒ½åˆ†æ                             â”‚
â”‚  â””â”€â”€ å¿«é€Ÿè·³è½¬åˆ° Grafana/Prometheus                      â”‚
â”‚                                                         â”‚
â”‚  Grafana ä»ªè¡¨æ¿ (http://localhost:3001)                 â”‚
â”‚  â”œâ”€â”€ å¯è§†åŒ–å›¾è¡¨å’Œä»ªè¡¨æ¿                                  â”‚
â”‚  â”œâ”€â”€ è‡ªå®šä¹‰æ—¶é—´èŒƒå›´æŸ¥è¯¢                                  â”‚
â”‚  â”œâ”€â”€ å‘Šè­¦è§„åˆ™é…ç½®                                       â”‚
â”‚  â””â”€â”€ æ•°æ®å¯¼å‡ºå’Œåˆ†äº«                                     â”‚
â”‚                                                         â”‚
â”‚  Prometheus (http://localhost:9090)                    â”‚
â”‚  â”œâ”€â”€ æŒ‡æ ‡æ”¶é›†å’Œå­˜å‚¨                                      â”‚
â”‚  â”œâ”€â”€ PromQL æŸ¥è¯¢                                        â”‚
â”‚  â”œâ”€â”€ ç›®æ ‡ç›‘æ§                                           â”‚
â”‚  â””â”€â”€ è§„åˆ™è¯„ä¼°                                           â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä½¿ç”¨åœºæ™¯

| åœºæ™¯ | ä½¿ç”¨å·¥å…· | åŸå›  |
|------|---------|------|
| æ—¥å¸¸å·¡æ£€ | Admin å¥åº·æ£€æŸ¥ | å¿«é€ŸæŸ¥çœ‹æœåŠ¡æ˜¯å¦æ­£å¸¸ |
| ä¸šåŠ¡æ“ä½œ | Admin å“åº”æ—¶é—´ç›‘æ§ | äº†è§£å½“å‰æœåŠ¡æ€§èƒ½ |
| æ€§èƒ½è°ƒä¼˜ | Grafana è¯¦ç»†å›¾è¡¨ | åˆ†æå†å²è¶‹åŠ¿ã€å®šä½ç“¶é¢ˆ |
| æ•…éšœæ’æŸ¥ | Grafana + Prometheus | ç»“åˆç›‘æ§å’Œæ—¥å¿—åˆ†æ |
| å®¹é‡è§„åˆ’ | Grafana é•¿æœŸè¶‹åŠ¿ | æŸ¥çœ‹å‘¨/æœˆç»´åº¦æ•°æ® |

## ğŸ“ ç›®å½•ç»“æ„

```
monitoring/
â”œâ”€â”€ prometheus/
â”‚   â”œâ”€â”€ prometheus.yml     # Prometheus ä¸»é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ alerts.yml         # å‘Šè­¦è§„åˆ™é…ç½®
â””â”€â”€ grafana/
    â”œâ”€â”€ provisioning/
    â”‚   â”œâ”€â”€ datasources/   # æ•°æ®æºé…ç½®ï¼ˆè‡ªåŠ¨é…ç½® Prometheusï¼‰
    â”‚   â””â”€â”€ dashboards/    # ä»ªè¡¨æ¿é…ç½®
    â””â”€â”€ dashboards/
        â””â”€â”€ stock-analysis-overview.json  # ä¸»ç›‘æ§ä»ªè¡¨æ¿
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨ç›‘æ§æœåŠ¡

ä½¿ç”¨ docker-compose å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆåŒ…æ‹¬ç›‘æ§ï¼‰ï¼š

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# åªå¯åŠ¨ç›‘æ§æœåŠ¡
docker-compose up -d prometheus grafana
```

### 2. è®¿é—®ç›‘æ§ç•Œé¢

å¯åŠ¨åï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®ï¼š

- **Admin ç›‘æ§é¡µé¢** â­ æ¨èæ—¥å¸¸ä½¿ç”¨: http://localhost:3002/monitor
  - å®æ—¶æœåŠ¡å¥åº·çŠ¶æ€ï¼ˆæ¯ 10 ç§’è‡ªåŠ¨åˆ·æ–°ï¼‰
  - æ•°æ®åº“å’Œ Redis å“åº”æ—¶é—´ç›‘æ§
  - ä¸€é”®è·³è½¬åˆ°è¯¦ç»†ç›‘æ§å·¥å…·

- **Grafana**: http://localhost:3001
  - ç”¨æˆ·å: `admin`
  - å¯†ç : `admin123`
  - é¦–æ¬¡ç™»å½•åå»ºè®®ä¿®æ”¹å¯†ç 

- **Prometheus**: http://localhost:9090
  - æŸ¥çœ‹åŸå§‹æŒ‡æ ‡æ•°æ®
  - æµ‹è¯• PromQL æŸ¥è¯¢

- **Backend Metrics**: http://localhost:8000/metrics
  - Backend API æš´éœ²çš„ Prometheus æŒ‡æ ‡ç«¯ç‚¹

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### HTTP è¯·æ±‚æŒ‡æ ‡

- `http_requests_total` - HTTP è¯·æ±‚æ€»æ•°ï¼ˆæŒ‰æ–¹æ³•ã€ç«¯ç‚¹ã€çŠ¶æ€ç åˆ†ç±»ï¼‰
- `http_request_duration_seconds` - HTTP è¯·æ±‚å“åº”æ—¶é—´ç›´æ–¹å›¾
- `http_request_size_bytes` - HTTP è¯·æ±‚å¤§å°ç›´æ–¹å›¾
- `http_response_size_bytes` - HTTP å“åº”å¤§å°ç›´æ–¹å›¾

### ç¼“å­˜æŒ‡æ ‡

- `cache_hit_rate` - ç¼“å­˜å‘½ä¸­ç‡ï¼ˆ0-1ï¼‰
- `cache_hits_total` - ç¼“å­˜å‘½ä¸­æ¬¡æ•°ï¼ˆæŒ‰ç¼“å­˜ç±»å‹åˆ†ç±»ï¼‰
- `cache_misses_total` - ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°ï¼ˆæŒ‰ç¼“å­˜ç±»å‹åˆ†ç±»ï¼‰

### æ•°æ®åº“æŒ‡æ ‡

- `database_connection_pool_size` - æ•°æ®åº“è¿æ¥æ± å¤§å°
- `database_connection_pool_in_use` - æ­£åœ¨ä½¿ç”¨çš„æ•°æ®åº“è¿æ¥æ•°
- `database_query_duration_seconds` - æ•°æ®åº“æŸ¥è¯¢å“åº”æ—¶é—´ç›´æ–¹å›¾

### ä¸šåŠ¡æŒ‡æ ‡

- `data_sync_tasks_total` - æ•°æ®åŒæ­¥ä»»åŠ¡è®¡æ•°ï¼ˆæŒ‰çŠ¶æ€åˆ†ç±»ï¼‰
- `backtest_tasks_total` - å›æµ‹ä»»åŠ¡è®¡æ•°ï¼ˆæŒ‰çŠ¶æ€åˆ†ç±»ï¼‰
- `feature_calculation_tasks_total` - ç‰¹å¾è®¡ç®—ä»»åŠ¡è®¡æ•°ï¼ˆæŒ‰çŠ¶æ€åˆ†ç±»ï¼‰

### å¥åº·æ£€æŸ¥æŒ‡æ ‡

- `health_check_failures_total` - å¥åº·æ£€æŸ¥å¤±è´¥æ¬¡æ•°ï¼ˆæŒ‰æœåŠ¡åˆ†ç±»ï¼‰

## ğŸ”” å‘Šè­¦è§„åˆ™

ç³»ç»Ÿé…ç½®äº†ä»¥ä¸‹å‘Šè­¦è§„åˆ™ï¼ˆè§ `prometheus/alerts.yml`ï¼‰ï¼š

### Backend API å‘Šè­¦

- **HighErrorRate** - 5xx é”™è¯¯ç‡è¶…è¿‡ 5%ï¼ˆæŒç»­ 5 åˆ†é’Ÿï¼‰
- **SlowResponseTime** - P95 å“åº”æ—¶é—´è¶…è¿‡ 1 ç§’ï¼ˆæŒç»­ 5 åˆ†é’Ÿï¼‰
- **VerySlowResponseTime** - P95 å“åº”æ—¶é—´è¶…è¿‡ 3 ç§’ï¼ˆæŒç»­ 2 åˆ†é’Ÿï¼‰âš ï¸ ä¸¥é‡
- **HighRequestRate** - è¯·æ±‚é‡è¶…è¿‡ 100 req/sï¼ˆæŒç»­ 5 åˆ†é’Ÿï¼‰
- **LowRequestRate** - è¯·æ±‚é‡ä½äº 0.1 req/sï¼ˆæŒç»­ 10 åˆ†é’Ÿï¼‰

### ç¼“å­˜å‘Šè­¦

- **LowCacheHitRate** - ç¼“å­˜å‘½ä¸­ç‡ä½äº 50%ï¼ˆæŒç»­ 10 åˆ†é’Ÿï¼‰
- **CacheNotUsed** - ç¼“å­˜åœ¨è¿‡å» 10 åˆ†é’Ÿå†…æ²¡æœ‰ä»»ä½•æ“ä½œ

### æ•°æ®åº“å‘Šè­¦

- **HighDatabaseConnectionUsage** - è¿æ¥æ± ä½¿ç”¨ç‡è¶…è¿‡ 80%ï¼ˆæŒç»­ 5 åˆ†é’Ÿï¼‰
- **SlowDatabaseQuery** - P95 æŸ¥è¯¢æ—¶é—´è¶…è¿‡ 2 ç§’ï¼ˆæŒç»­ 5 åˆ†é’Ÿï¼‰

### æœåŠ¡å¥åº·å‘Šè­¦

- **ServiceDown** - æœåŠ¡å®•æœºè¶…è¿‡ 1 åˆ†é’Ÿ âš ï¸ ä¸¥é‡
- **HealthCheckFailed** - å¥åº·æ£€æŸ¥å¤±è´¥ç‡è¶…è¿‡ 10%ï¼ˆæŒç»­ 5 åˆ†é’Ÿï¼‰

## ğŸ“ˆ Grafana ä»ªè¡¨æ¿

ç³»ç»Ÿæä¾›äº†ä¸€ä¸ªé¢„é…ç½®çš„ Grafana ä»ªè¡¨æ¿ "Stock Analysis - Overview"ï¼ŒåŒ…å«ï¼š

1. **é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡**
   - è¯·æ±‚é€Ÿç‡ï¼ˆreq/sï¼‰
   - P95 å“åº”æ—¶é—´
   - ç¼“å­˜å‘½ä¸­ç‡
   - é”™è¯¯ç‡

2. **API è¯·æ±‚é‡å›¾è¡¨**
   - æŒ‰ç«¯ç‚¹åˆ†ç±»çš„è¯·æ±‚é€Ÿç‡æ—¶é—´åºåˆ—

3. **API å“åº”æ—¶é—´å›¾è¡¨**
   - P50ã€P95ã€P99 å“åº”æ—¶é—´ï¼ˆæŒ‰ç«¯ç‚¹åˆ†ç±»ï¼‰

4. **ç¼“å­˜å‘½ä¸­/æœªå‘½ä¸­é€Ÿç‡å›¾è¡¨**
   - æŒ‰ç¼“å­˜ç±»å‹åˆ†ç±»çš„å‘½ä¸­å’Œæœªå‘½ä¸­é€Ÿç‡

5. **æ•°æ®åº“è¿æ¥æ± çŠ¶æ€å›¾è¡¨**
   - è¿æ¥æ± å¤§å°å’Œä½¿ç”¨ä¸­çš„è¿æ¥æ•°

## ğŸ”§ é…ç½®è¯´æ˜

### Prometheus é…ç½®

- **æŠ“å–é—´éš”**: 15 ç§’ï¼ˆå…¨å±€é»˜è®¤ï¼‰
- **Backend API æŠ“å–**: æ¯ 10 ç§’ä¸€æ¬¡
- **å‘Šè­¦è§„åˆ™**: æ¯ 15 ç§’è¯„ä¼°ä¸€æ¬¡

### Grafana é…ç½®

- **æ•°æ®æº**: è‡ªåŠ¨é…ç½® Prometheusï¼ˆhttp://prometheus:9090ï¼‰
- **ä»ªè¡¨æ¿**: è‡ªåŠ¨åŠ è½½æ‰€æœ‰ JSON é…ç½®æ–‡ä»¶
- **åˆ·æ–°é—´éš”**: 10 ç§’è‡ªåŠ¨åˆ·æ–°

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### Prometheus æ— æ³•æŠ“å– Backend æŒ‡æ ‡

1. æ£€æŸ¥ Backend æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š
   ```bash
   curl http://localhost:8000/health
   ```

2. æ£€æŸ¥ Backend æŒ‡æ ‡ç«¯ç‚¹ï¼š
   ```bash
   curl http://localhost:8000/metrics
   ```

3. æŸ¥çœ‹ Prometheus æ—¥å¿—ï¼š
   ```bash
   docker-compose logs prometheus
   ```

### Grafana æ— æ³•è¿æ¥ Prometheus

1. æ£€æŸ¥ Prometheus æœåŠ¡çŠ¶æ€ï¼š
   ```bash
   docker-compose ps prometheus
   ```

2. åœ¨ Grafana ä¸­æµ‹è¯•æ•°æ®æºè¿æ¥ï¼š
   - è¿›å…¥ Configuration > Data Sources > Prometheus
   - ç‚¹å‡» "Test" æŒ‰é’®

3. æŸ¥çœ‹ Grafana æ—¥å¿—ï¼š
   ```bash
   docker-compose logs grafana
   ```

### æŒ‡æ ‡æ•°æ®ä¸ºç©º

1. ç¡®ä¿ Backend åº”ç”¨å·²å¯åŠ¨å¹¶æ¥æ”¶è¯·æ±‚
2. ç­‰å¾…è‡³å°‘ä¸€ä¸ªæŠ“å–é—´éš”ï¼ˆ10-15 ç§’ï¼‰
3. æ£€æŸ¥ Prometheus Targets é¡µé¢ï¼ˆhttp://localhost:9090/targetsï¼‰

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Prometheus å®˜æ–¹æ–‡æ¡£](https://prometheus.io/docs/)
- [Grafana å®˜æ–¹æ–‡æ¡£](https://grafana.com/docs/)
- [PromQL æŸ¥è¯¢è¯­è¨€](https://prometheus.io/docs/prometheus/latest/querying/basics/)

## ğŸ” å®‰å…¨å»ºè®®

ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ—¶ï¼Œå»ºè®®ï¼š

1. **ä¿®æ”¹é»˜è®¤å¯†ç **: æ›´æ”¹ Grafana çš„é»˜è®¤ç®¡ç†å‘˜å¯†ç 
2. **é…ç½®è®¤è¯**: ä¸º Prometheus æ·»åŠ åŸºæœ¬è®¤è¯æˆ–åå‘ä»£ç†
3. **é™åˆ¶è®¿é—®**: ä½¿ç”¨é˜²ç«å¢™è§„åˆ™é™åˆ¶ç›‘æ§ç«¯å£çš„è®¿é—®
4. **HTTPS**: é…ç½® SSL/TLS è¯ä¹¦
5. **å‘Šè­¦é€šçŸ¥**: é…ç½® Alertmanager å‘é€é‚®ä»¶/Slack/é’‰é’‰é€šçŸ¥

## ğŸ“ ç»´æŠ¤è¯´æ˜

### æ·»åŠ æ–°æŒ‡æ ‡

1. åœ¨ `backend/app/middleware/metrics.py` ä¸­å®šä¹‰æ–°æŒ‡æ ‡
2. åœ¨ç›¸åº”çš„ä»£ç ä½ç½®è®°å½•æŒ‡æ ‡å€¼
3. æ›´æ–° Grafana ä»ªè¡¨æ¿ä»¥å¯è§†åŒ–æ–°æŒ‡æ ‡

### æ·»åŠ æ–°å‘Šè­¦è§„åˆ™

1. ç¼–è¾‘ `prometheus/alerts.yml`
2. é‡æ–°åŠ è½½ Prometheus é…ç½®ï¼š
   ```bash
   docker-compose restart prometheus
   ```

### æ›´æ–° Grafana ä»ªè¡¨æ¿

1. åœ¨ Grafana UI ä¸­ç¼–è¾‘ä»ªè¡¨æ¿
2. å¯¼å‡º JSON é…ç½®
3. ä¿å­˜åˆ° `monitoring/grafana/dashboards/`
4. é‡å¯ Grafana å®¹å™¨ï¼ˆæˆ–ç­‰å¾…è‡ªåŠ¨é‡æ–°åŠ è½½ï¼‰
