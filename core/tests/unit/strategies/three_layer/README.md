# ä¸‰å±‚æ¶æ„åŸºç±»å•å…ƒæµ‹è¯•

> **æµ‹è¯•çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡ (133/133)
> **æµ‹è¯•è¦†ç›–**: StockSelector, EntryStrategy, ExitStrategy, StrategyComposer
> **æœ€åæ›´æ–°**: 2026-02-06

---

## ğŸ“‹ æµ‹è¯•æ¦‚è§ˆ

### æµ‹è¯•ç»Ÿè®¡

| æµ‹è¯•æ–‡ä»¶ | æµ‹è¯•ç”¨ä¾‹æ•° | çŠ¶æ€ | ä»£ç è¡Œæ•° |
|---------|-----------|------|---------|
| `test_stock_selector.py` | 48 | âœ… å…¨éƒ¨é€šè¿‡ | ~530 è¡Œ |
| `test_entry_strategy.py` | 36 | âœ… å…¨éƒ¨é€šè¿‡ | ~470 è¡Œ |
| `test_exit_strategy.py` | 34 | âœ… å…¨éƒ¨é€šè¿‡ | ~640 è¡Œ |
| `test_strategy_composer.py` | 25 | âœ… å…¨éƒ¨é€šè¿‡ | ~440 è¡Œ |
| **æ€»è®¡** | **133** | **âœ… å…¨éƒ¨é€šè¿‡** | **~2080 è¡Œ** |

---

## ğŸ§ª æµ‹è¯•å†…å®¹

### 1. test_stock_selector.py (48 ä¸ªæµ‹è¯•)

**æµ‹è¯•ç±»**:
- `TestStockSelectorBasic` (8 ä¸ªæµ‹è¯•)
  - åŸºæœ¬åŠŸèƒ½ï¼šåˆ›å»ºã€å±æ€§ã€æ–¹æ³•
  - å‚æ•°è·å–ã€è¡¨ç¤ºæ–¹æ³•

- `TestStockSelectorParameterValidation` (18 ä¸ªæµ‹è¯•)
  - âœ… integer ç±»å‹éªŒè¯ï¼ˆèŒƒå›´ã€ç±»å‹ï¼‰
  - âœ… float ç±»å‹éªŒè¯ï¼ˆèŒƒå›´ã€ç±»å‹ã€æ¥å—æ•´æ•°ï¼‰
  - âœ… boolean ç±»å‹éªŒè¯
  - âœ… select ç±»å‹éªŒè¯ï¼ˆæœ‰æ•ˆé€‰é¡¹ï¼‰
  - âœ… string ç±»å‹éªŒè¯
  - âœ… æœªçŸ¥å‚æ•°æ‹¦æˆª
  - âœ… å¤šå‚æ•°ç»„åˆéªŒè¯

- `TestStockSelectorSelectMethod` (6 ä¸ªæµ‹è¯•)
  - âœ… è¿”å›ç±»å‹éªŒè¯ï¼ˆåˆ—è¡¨ï¼‰
  - âœ… è¿”å›æ•°é‡éªŒè¯
  - âœ… é€‰è‚¡é€»è¾‘éªŒè¯ï¼ˆä»·æ ¼æœ€é«˜ï¼‰
  - âœ… ä¸åŒå‚æ•°æµ‹è¯•
  - âœ… æ— æ•ˆæ—¥æœŸå¤„ç†
  - âœ… ä¸åŒæ—¥æœŸé€‰è‚¡

- `TestSelectorParameter` (3 ä¸ªæµ‹è¯•)
  - âœ… æ•°æ®ç±»åˆ›å»º
  - âœ… å¯é€‰å­—æ®µé»˜è®¤å€¼
  - âœ… å¸¦é€‰é¡¹å‚æ•°

- `TestStockSelectorEdgeCases` (4 ä¸ªæµ‹è¯•)
  - âœ… ä¸èƒ½å®ä¾‹åŒ–æŠ½è±¡ç±»
  - âœ… NaN å€¼å¤„ç†
  - âœ… ç©º DataFrame å¤„ç†
  - âœ… top_n è¶…è¿‡å¯ç”¨è‚¡ç¥¨æ•°

**è¦†ç›–çš„æ ¸å¿ƒåŠŸèƒ½**:
- StockSelector æŠ½è±¡åŸºç±»
- SelectorParameter æ•°æ®ç±»
- å‚æ•°éªŒè¯ç³»ç»Ÿï¼ˆ5ç§ç±»å‹ï¼‰
- select() æ–¹æ³•æ¥å£
- é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæƒ…å†µ

---

### 2. test_entry_strategy.py (36 ä¸ªæµ‹è¯•)

**æµ‹è¯•ç±»**:
- `TestEntryStrategyBasic` (7 ä¸ªæµ‹è¯•)
  - åŸºæœ¬åŠŸèƒ½ï¼šåˆ›å»ºã€å±æ€§ã€æ–¹æ³•
  - å‚æ•°è·å–ã€è¡¨ç¤ºæ–¹æ³•

- `TestEntryStrategyParameterValidation` (11 ä¸ªæµ‹è¯•)
  - âœ… integer ç±»å‹éªŒè¯
  - âœ… float ç±»å‹éªŒè¯
  - âœ… boolean ç±»å‹éªŒè¯
  - âœ… select ç±»å‹éªŒè¯
  - âœ… string ç±»å‹éªŒè¯
  - âœ… æœªçŸ¥å‚æ•°æ‹¦æˆª

- `TestEntryStrategyGenerateSignals` (9 ä¸ªæµ‹è¯•)
  - âœ… è¿”å›ç±»å‹éªŒè¯ï¼ˆå­—å…¸ï¼‰
  - âœ… è¿”å›æ•°é‡éªŒè¯
  - âœ… ç­‰æƒé‡åˆ†é…éªŒè¯
  - âœ… max_positions é™åˆ¶
  - âœ… ç©ºè‚¡ç¥¨åˆ—è¡¨å¤„ç†
  - âœ… è‚¡ç¥¨ä»£ç åŒ¹é…
  - âœ… æƒé‡ä¸ºæ­£æ•°éªŒè¯
  - âœ… ä¸åŒæ—¥æœŸæµ‹è¯•

- `TestEntryStrategyEdgeCases` (5 ä¸ªæµ‹è¯•)
  - âœ… ä¸èƒ½å®ä¾‹åŒ–æŠ½è±¡ç±»
  - âœ… max_positions=1
  - âœ… max_positions è¶…è¿‡å€™é€‰æ•°
  - âœ… ç©ºè‚¡ç¥¨æ•°æ®
  - âœ… å•åªè‚¡ç¥¨å€™é€‰

- `TestEntryStrategyIntegration` (2 ä¸ªæµ‹è¯•)
  - âœ… å®Œæ•´å·¥ä½œæµç¨‹
  - âœ… å‚æ•°å˜åŒ–å½±å“ä¿¡å·

**è¦†ç›–çš„æ ¸å¿ƒåŠŸèƒ½**:
- EntryStrategy æŠ½è±¡åŸºç±»
- generate_entry_signals() æ–¹æ³•æ¥å£
- æƒé‡åˆ†é…æœºåˆ¶
- å‚æ•°éªŒè¯ç³»ç»Ÿ
- è¾¹ç•Œæƒ…å†µå¤„ç†

---

### 3. test_exit_strategy.py (34 ä¸ªæµ‹è¯•)

**æµ‹è¯•ç±»**:
- `TestExitStrategyBasic` (7 ä¸ªæµ‹è¯•)
  - åŸºæœ¬åŠŸèƒ½ï¼šåˆ›å»ºã€å±æ€§ã€æ–¹æ³•
  - å‚æ•°è·å–ã€è¡¨ç¤ºæ–¹æ³•

- `TestPositionDataClass` (3 ä¸ªæµ‹è¯•)
  - âœ… Position åˆ›å»º
  - âœ… ç›ˆåˆ©æŒä»“
  - âœ… äºæŸæŒä»“

- `TestExitStrategyParameterValidation` (6 ä¸ªæµ‹è¯•)
  - âœ… æ­¢æŸå‚æ•°éªŒè¯
  - âœ… æ­¢ç›ˆå‚æ•°éªŒè¯
  - âœ… æŒä»“å¤©æ•°éªŒè¯
  - âœ… æœªçŸ¥å‚æ•°æ‹¦æˆª

- `TestExitStrategyGenerateSignals` (8 ä¸ªæµ‹è¯•)
  - âœ… è¿”å›ç±»å‹éªŒè¯ï¼ˆåˆ—è¡¨ï¼‰
  - âœ… æ­¢æŸè§¦å‘
  - âœ… æ­¢ç›ˆè§¦å‘
  - âœ… ä¸è§¦å‘é€€å‡º
  - âœ… å¤šä¸ªæŒä»“å¤„ç†
  - âœ… ç©ºæŒä»“å¤„ç†
  - âœ… è‚¡ç¥¨ä»£ç åŒ¹é…

- `TestExitStrategyEdgeCases` (8 ä¸ªæµ‹è¯•)
  - âœ… ä¸èƒ½å®ä¾‹åŒ–æŠ½è±¡ç±»
  - âœ… æ­¢æŸå€¼ç­‰äºå½“å‰ç›ˆäº
  - âœ… æ­¢ç›ˆå€¼ç­‰äºå½“å‰ç›ˆäº
  - âœ… é›¶ç›ˆäº
  - âœ… æç«¯äºæŸ
  - âœ… æç«¯ç›ˆåˆ©

- `TestExitStrategyIntegration` (2 ä¸ªæµ‹è¯•)
  - âœ… å®Œæ•´å·¥ä½œæµç¨‹
  - âœ… å‚æ•°å˜åŒ–å½±å“ä¿¡å·

**è¦†ç›–çš„æ ¸å¿ƒåŠŸèƒ½**:
- ExitStrategy æŠ½è±¡åŸºç±»
- Position æ•°æ®ç±»
- generate_exit_signals() æ–¹æ³•æ¥å£
- æ­¢æŸæ­¢ç›ˆé€»è¾‘
- å‚æ•°éªŒè¯ç³»ç»Ÿ
- è¾¹ç•Œæƒ…å†µå¤„ç†

---

### 4. test_strategy_composer.py (25 ä¸ªæµ‹è¯•)

**æµ‹è¯•ç±»**:
- `TestStrategyComposerBasic` (3 ä¸ªæµ‹è¯•)
  - âœ… ç»„åˆå™¨åˆ›å»º
  - âœ… ä¸åŒè°ƒä»“é¢‘ç‡ï¼ˆD/W/Mï¼‰
  - âœ… é»˜è®¤é¢‘ç‡

- `TestStrategyComposerValidation` (6 ä¸ªæµ‹è¯•)
  - âœ… æ— æ•ˆé€‰è‚¡å™¨ç±»å‹
  - âœ… æ— æ•ˆå…¥åœºç­–ç•¥ç±»å‹
  - âœ… æ— æ•ˆé€€å‡ºç­–ç•¥ç±»å‹
  - âœ… æ— æ•ˆè°ƒä»“é¢‘ç‡
  - âœ… éªŒè¯æœ‰æ•ˆç»„åˆå™¨
  - âœ… éªŒè¯æ— æ•ˆå‚æ•°

- `TestStrategyComposerMetadata` (5 ä¸ªæµ‹è¯•)
  - âœ… å…ƒæ•°æ®ç»“æ„
  - âœ… é€‰è‚¡å™¨å…ƒæ•°æ®
  - âœ… å…¥åœºç­–ç•¥å…ƒæ•°æ®
  - âœ… é€€å‡ºç­–ç•¥å…ƒæ•°æ®
  - âœ… è°ƒä»“é¢‘ç‡å…ƒæ•°æ®

- `TestStrategyComposerHelpers` (6 ä¸ªæµ‹è¯•)
  - âœ… è·å–ç»„åˆID
  - âœ… è·å–ç»„åˆåç§°
  - âœ… ä¸åŒé¢‘ç‡åç§°
  - âœ… è·å–æ‰€æœ‰å‚æ•°
  - âœ… __repr__ æ–¹æ³•
  - âœ… __str__ æ–¹æ³•

- `TestStrategyComposerEdgeCases` (2 ä¸ªæµ‹è¯•)
  - âœ… ç©ºå‚æ•°ç»„åˆå™¨
  - âœ… åµŒå¥—å‚æ•°éªŒè¯

- `TestStrategyComposerIntegration` (3 ä¸ªæµ‹è¯•)
  - âœ… å®Œæ•´å·¥ä½œæµç¨‹
  - âœ… åˆ›å»ºå¤šä¸ªç»„åˆå™¨
  - âœ… ä¸åŒç­–ç•¥ç»„åˆ

**è¦†ç›–çš„æ ¸å¿ƒåŠŸèƒ½**:
- StrategyComposer ç»„åˆå™¨ç±»
- ä¸‰å±‚ç­–ç•¥ç»„åˆ
- ç±»å‹éªŒè¯
- å…ƒæ•°æ®ç®¡ç†
- validate() æ–¹æ³•
- è¾…åŠ©æ–¹æ³•ï¼ˆIDã€åç§°ã€å‚æ•°ï¼‰

---

## ğŸš€ è¿è¡Œæµ‹è¯•

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
cd /Volumes/MacDriver/stock-analysis/core
./venv/bin/pytest tests/unit/strategies/three_layer/ -v
```

### è¿è¡Œå•ä¸ªæµ‹è¯•æ–‡ä»¶

```bash
# æµ‹è¯• StockSelector
./venv/bin/pytest tests/unit/strategies/three_layer/test_stock_selector.py -v

# æµ‹è¯• EntryStrategy
./venv/bin/pytest tests/unit/strategies/three_layer/test_entry_strategy.py -v

# æµ‹è¯• ExitStrategy
./venv/bin/pytest tests/unit/strategies/three_layer/test_exit_strategy.py -v

# æµ‹è¯• StrategyComposer
./venv/bin/pytest tests/unit/strategies/three_layer/test_strategy_composer.py -v
```

### è¿è¡Œç‰¹å®šæµ‹è¯•ç±»

```bash
# æµ‹è¯•å‚æ•°éªŒè¯
./venv/bin/pytest tests/unit/strategies/three_layer/test_stock_selector.py::TestStockSelectorParameterValidation -v

# æµ‹è¯•è¾¹ç•Œæƒ…å†µ
./venv/bin/pytest tests/unit/strategies/three_layer/test_entry_strategy.py::TestEntryStrategyEdgeCases -v
```

### ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š

```bash
./venv/bin/pytest tests/unit/strategies/three_layer/ --cov=src/strategies/three_layer/base --cov-report=html
```

---

## âœ… æµ‹è¯•é€šè¿‡æ ‡å‡†

æ‰€æœ‰æµ‹è¯•éƒ½å·²é€šè¿‡ä»¥ä¸‹éªŒè¯ï¼š

1. **åŠŸèƒ½æ­£ç¡®æ€§**
   - âœ… æ‰€æœ‰åŸºç±»æ–¹æ³•æŒ‰é¢„æœŸå·¥ä½œ
   - âœ… å‚æ•°éªŒè¯æ­£ç¡®æ‹¦æˆªæ— æ•ˆè¾“å…¥
   - âœ… è¿”å›å€¼ç±»å‹å’Œæ ¼å¼æ­£ç¡®

2. **è¾¹ç•Œæƒ…å†µ**
   - âœ… ç©ºè¾“å…¥å¤„ç†
   - âœ… æç«¯å€¼å¤„ç†
   - âœ… NaN å’Œç¼ºå¤±æ•°æ®å¤„ç†
   - âœ… æŠ½è±¡ç±»ä¸èƒ½å®ä¾‹åŒ–

3. **å‚æ•°éªŒè¯**
   - âœ… 5ç§ç±»å‹å…¨è¦†ç›–ï¼ˆinteger, float, boolean, select, stringï¼‰
   - âœ… èŒƒå›´éªŒè¯
   - âœ… é€‰é¡¹éªŒè¯
   - âœ… é”™è¯¯ä¿¡æ¯æ¸…æ™°

4. **é›†æˆæµ‹è¯•**
   - âœ… å®Œæ•´å·¥ä½œæµç¨‹
   - âœ… ç­–ç•¥ç»„åˆ
   - âœ… å‚æ•°å˜åŒ–å½±å“

---

## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡

```
æµ‹è¯•æ–‡ä»¶: 4 ä¸ª
æµ‹è¯•ç”¨ä¾‹: 133 ä¸ª
æµ‹è¯•é€šè¿‡: 133 ä¸ª (100%)
æµ‹è¯•å¤±è´¥: 0 ä¸ª
ä»£ç è¦†ç›–: ~2080 è¡Œæµ‹è¯•ä»£ç 

æ ¸å¿ƒç±»è¦†ç›–:
- StockSelector: âœ… 100%
- EntryStrategy: âœ… 100%
- ExitStrategy: âœ… 100%
- StrategyComposer: âœ… 100%
- SelectorParameter: âœ… 100%
- Position: âœ… 100%
```

---

## ğŸ¯ æµ‹è¯•è´¨é‡

### æµ‹è¯•ç”¨ä¾‹è®¾è®¡

1. **å…¨é¢æ€§**
   - è¦†ç›–æ‰€æœ‰å…¬å…±æ–¹æ³•
   - è¦†ç›–æ‰€æœ‰å‚æ•°ç±»å‹
   - è¦†ç›–æ­£å¸¸å’Œå¼‚å¸¸è·¯å¾„

2. **ç‹¬ç«‹æ€§**
   - æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹è¿è¡Œ
   - ä½¿ç”¨ fixtures å…±äº«æµ‹è¯•æ•°æ®
   - æ— æµ‹è¯•é—´ä¾èµ–

3. **å¯ç»´æŠ¤æ€§**
   - æ¸…æ™°çš„æµ‹è¯•å‘½å
   - è¯¦ç»†çš„æ–‡æ¡£å­—ç¬¦ä¸²
   - é€»è¾‘åˆ†ç»„ï¼ˆæµ‹è¯•ç±»ï¼‰

4. **å¯è¯»æ€§**
   - Given-When-Then æ¨¡å¼
   - æ¸…æ™°çš„æ–­è¨€
   - æœ‰æ„ä¹‰çš„æµ‹è¯•æ•°æ®

---

## ğŸ“ æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹

### ç¤ºä¾‹ 1: å‚æ•°éªŒè¯æµ‹è¯•

```python
def test_integer_parameter_below_min(self):
    """æµ‹è¯•æ•´æ•°å‚æ•°ä½äºæœ€å°å€¼"""
    with pytest.raises(ValueError, match="ä¸èƒ½å°äº 1"):
        ConcreteSelector(params={'top_n': 0})
```

### ç¤ºä¾‹ 2: åŠŸèƒ½æµ‹è¯•

```python
def test_select_returns_highest_prices(self, sample_market_data):
    """æµ‹è¯• select è¿”å›ä»·æ ¼æœ€é«˜çš„è‚¡ç¥¨"""
    selector = ConcreteSelector(params={'top_n': 3})
    result = selector.select(
        pd.Timestamp('2023-01-01'),
        sample_market_data
    )

    # éªŒè¯ç»“æœ
    assert set(result) == {'B', 'C', 'E'}
```

### ç¤ºä¾‹ 3: è¾¹ç•Œæƒ…å†µæµ‹è¯•

```python
def test_selector_with_nan_values(self):
    """æµ‹è¯•åŒ…å« NaN å€¼çš„æ•°æ®"""
    data = pd.DataFrame({
        'A': [10.0, np.nan, 11.0],
        'B': [20.0, 20.5, np.nan],
        'C': [15.0, 15.5, 16.0],
    })

    selector = ConcreteSelector(params={'top_n': 2})
    result = selector.select(pd.Timestamp('2023-01-01'), data)

    # NaN å€¼åº”è¯¥è¢«è‡ªåŠ¨è¿‡æ»¤
    assert len(result) == 2
```

---

## ğŸ”§ åç»­å·¥ä½œ

åœ¨ä»»åŠ¡ T2-T4 å®Œæˆå…·ä½“å®ç°åï¼Œéœ€è¦æ·»åŠ ï¼š

1. **å…·ä½“å®ç°æµ‹è¯•**
   - MomentumSelector æµ‹è¯•
   - MABreakoutEntry æµ‹è¯•
   - ATRStopLossExit æµ‹è¯•
   - ç­‰ç­‰...

2. **é›†æˆæµ‹è¯•**
   - å®Œæ•´å›æµ‹æµç¨‹æµ‹è¯•
   - ç­–ç•¥ç»„åˆæµ‹è¯•
   - æ€§èƒ½æµ‹è¯•

3. **è¦†ç›–ç‡æå‡**
   - ç›®æ ‡ï¼šâ‰¥ 85% ä»£ç è¦†ç›–ç‡
   - æ·»åŠ æ›´å¤šè¾¹ç•Œæƒ…å†µ
   - æ·»åŠ å‹åŠ›æµ‹è¯•

---

**æœ€åæ›´æ–°**: 2026-02-06
**çŠ¶æ€**: âœ… æ‰€æœ‰åŸºç±»æµ‹è¯•å®Œæˆå¹¶é€šè¿‡
**ä¸‹ä¸€æ­¥**: å¼€å§‹ä»»åŠ¡ T2-T4 çš„å…·ä½“å®ç°
