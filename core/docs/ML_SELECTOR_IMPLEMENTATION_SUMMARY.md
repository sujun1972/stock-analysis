# MLSelector å®ç°å®Œæˆæ€»ç»“

> **ä»»åŠ¡**: ML-1 - MLSelector åŸºç±»å®ç°
> **å®Œæˆæ—¥æœŸ**: 2026-02-06
> **çŠ¶æ€**: âœ… å®Œæˆ

---

## ğŸ“‹ å®ç°æ¦‚è§ˆ

å·²æˆåŠŸå®ç° **MLSelectorï¼ˆæœºå™¨å­¦ä¹ é€‰è‚¡å™¨ï¼‰**ï¼Œåœ¨ Core é¡¹ç›®å†…éƒ¨å®ç°äº† StarRanker çš„åŠŸèƒ½ã€‚è¿™æ˜¯ä¸‰å±‚æ¶æ„çš„ç¬¬å››ä¸ªé€‰è‚¡å™¨ï¼Œæä¾›åŸºäºå¤šå› å­æ¨¡å‹å’Œæœºå™¨å­¦ä¹ çš„æ™ºèƒ½é€‰è‚¡èƒ½åŠ›ã€‚

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒå®ç°
- **[ml_selector.py](../src/strategies/three_layer/selectors/ml_selector.py)** - MLSelector åŸºç±»å®ç°ï¼ˆ783è¡Œï¼‰
  - å®Œæ•´çš„é€‰è‚¡é€»è¾‘
  - 11ç§æŠ€æœ¯ç‰¹å¾è®¡ç®—
  - 3ç§è¯„åˆ†æ¨¡å¼ï¼ˆå¤šå› å­åŠ æƒã€LightGBMã€è‡ªå®šä¹‰ï¼‰
  - ä»·æ ¼è¿‡æ»¤åŠŸèƒ½

### æµ‹è¯•æ–‡ä»¶
- **[test_ml_selector.py](../tests/unit/strategies/three_layer/selectors/test_ml_selector.py)** - å®Œæ•´å•å…ƒæµ‹è¯•ï¼ˆ765è¡Œï¼‰
  - 46ä¸ªæµ‹è¯•ç”¨ä¾‹
  - 100% é€šè¿‡ç‡
  - è¦†ç›–æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½

### ç¤ºä¾‹æ–‡ä»¶
- **[ml_selector_usage_example.py](../examples/ml_selector_usage_example.py)** - ä½¿ç”¨ç¤ºä¾‹ï¼ˆ298è¡Œï¼‰
  - 8ä¸ªå®Œæ•´ç¤ºä¾‹
  - æ¶µç›–æ‰€æœ‰ä½¿ç”¨åœºæ™¯

### æ¨¡å—å¯¼å‡º
- **[__init__.py](../src/strategies/three_layer/selectors/__init__.py)** - æ¨¡å—å¯¼å‡ºæ›´æ–°
  - æ·»åŠ  MLSelector åˆ° `__all__`

---

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### 1. ä¸‰ç§è¯„åˆ†æ¨¡å¼

| æ¨¡å¼ | æè¿° | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| **multi_factor_weighted** | å¤šå› å­åŠ æƒï¼ˆé»˜è®¤ï¼‰ | å¿«é€Ÿéƒ¨ç½²ï¼Œæ— éœ€è®­ç»ƒ |
| **lightgbm_ranker** | LightGBM æ’åºæ¨¡å‹ | é«˜çº§ç”¨æˆ·ï¼Œæœ‰è®­ç»ƒæ•°æ® |
| **custom_model** | è‡ªå®šä¹‰æ¨¡å‹ | ç ”ç©¶äººå‘˜ï¼Œç‰¹æ®Šéœ€æ±‚ |

### 2. 11ç§å†…ç½®æŠ€æœ¯ç‰¹å¾

#### åŠ¨é‡ç±»ç‰¹å¾ (4ä¸ª)
- `momentum_5d` - 5æ—¥åŠ¨é‡
- `momentum_10d` - 10æ—¥åŠ¨é‡
- `momentum_20d` - 20æ—¥åŠ¨é‡
- `momentum_60d` - 60æ—¥åŠ¨é‡

#### æŠ€æœ¯æŒ‡æ ‡ (2ä¸ª)
- `rsi_14d` - 14æ—¥RSI
- `rsi_28d` - 28æ—¥RSI

#### æ³¢åŠ¨ç‡ç‰¹å¾ (2ä¸ª)
- `volatility_20d` - 20æ—¥æ³¢åŠ¨ç‡
- `volatility_60d` - 60æ—¥æ³¢åŠ¨ç‡

#### å‡çº¿ç‰¹å¾ (2ä¸ª)
- `ma_cross_20d` - 20æ—¥å‡çº¿åç¦»åº¦
- `ma_cross_60d` - 60æ—¥å‡çº¿åç¦»åº¦

#### é£é™©æŒ‡æ ‡ (1ä¸ª)
- `atr_14d` - 14æ—¥ATRï¼ˆå¹³å‡çœŸå®æ³¢å¹…ï¼‰

### 3. è¿‡æ»¤åŠŸèƒ½

- **æœ€ä½ä»·æ ¼è¿‡æ»¤** (`filter_min_price`) - è¿‡æ»¤ä½äºæŒ‡å®šä»·æ ¼çš„è‚¡ç¥¨
- **æœ€é«˜ä»·æ ¼è¿‡æ»¤** (`filter_max_price`) - è¿‡æ»¤é«˜äºæŒ‡å®šä»·æ ¼çš„è‚¡ç¥¨
- **æˆäº¤é‡è¿‡æ»¤** (`filter_min_volume`) - é¢„ç•™æ¥å£ï¼ˆéœ€è¦æˆäº¤é‡æ•°æ®ï¼‰

### 4. å‚æ•°é…ç½®

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| mode | select | multi_factor_weighted | è¯„åˆ†æ¨¡å¼ |
| top_n | integer | 50 | é€‰è‚¡æ•°é‡ (5-200) |
| features | string | "momentum_20d,rsi_14d,volatility_20d,volume_ratio" | ç‰¹å¾åˆ—è¡¨ |
| model_path | string | "" | æ¨¡å‹æ–‡ä»¶è·¯å¾„ |
| filter_min_price | float | 0 | æœ€ä½ä»·æ ¼ |
| filter_max_price | float | 0 | æœ€é«˜ä»·æ ¼ |
| filter_min_volume | float | 0 | æœ€å°æˆäº¤é‡ |

---

## ğŸ§ª æµ‹è¯•è¦†ç›–

### æµ‹è¯•ç»Ÿè®¡
- **æµ‹è¯•ç±»**: 10ä¸ª
- **æµ‹è¯•ç”¨ä¾‹**: 46ä¸ª
- **é€šè¿‡ç‡**: 100% âœ…
- **æµ‹è¯•æ—¶é•¿**: ~1ç§’

### æµ‹è¯•åˆ†ç±»

| æµ‹è¯•ç±» | ç”¨ä¾‹æ•° | è¯´æ˜ |
|--------|--------|------|
| TestMLSelectorBasic | 6 | åŸºæœ¬åŠŸèƒ½ï¼ˆIDã€å‚æ•°ã€åˆå§‹åŒ–ï¼‰ |
| TestMLSelectorFeatureCalculation | 8 | ç‰¹å¾è®¡ç®—åŠŸèƒ½ |
| TestMLSelectorScoring | 5 | è¯„åˆ†åŠŸèƒ½ |
| TestMLSelectorSelection | 4 | é€‰è‚¡åŠŸèƒ½ |
| TestMLSelectorFiltering | 4 | è¿‡æ»¤åŠŸèƒ½ |
| TestMLSelectorEdgeCases | 4 | è¾¹ç•Œæƒ…å†µ |
| TestMLSelectorParameterValidation | 6 | å‚æ•°éªŒè¯ |
| TestMLSelectorIntegration | 3 | é›†æˆåœºæ™¯ |
| TestMLSelectorRSICalculation | 3 | RSIè®¡ç®— |
| TestMLSelectorRankAndSelect | 3 | æ’åºé€‰è‚¡ |

---

## ğŸ“Š ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ç”¨æ³•

```python
from src.strategies.three_layer.selectors import MLSelector

# åˆ›å»ºé€‰è‚¡å™¨
selector = MLSelector(params={
    'mode': 'multi_factor_weighted',
    'top_n': 50,
    'features': 'momentum_20d,rsi_14d,volatility_20d'
})

# é€‰è‚¡
selected_stocks = selector.select(date, market_data)
```

### ä¸ä¸‰å±‚æ¶æ„é›†æˆ

```python
from src.strategies.three_layer import StrategyComposer
from src.strategies.three_layer.selectors import MLSelector
from src.strategies.three_layer.entries import ImmediateEntry
from src.strategies.three_layer.exits import FixedStopLossExit

# ç»„åˆç­–ç•¥
composer = StrategyComposer(
    selector=MLSelector(params={
        'mode': 'multi_factor_weighted',
        'top_n': 50,
        'features': 'momentum_20d,rsi_14d,volatility_20d,ma_cross_20d'
    }),
    entry=ImmediateEntry(),
    exit_strategy=FixedStopLossExit(params={'stop_loss_pct': -5.0}),
    rebalance_freq='W'
)
```

### ä»·æ ¼è¿‡æ»¤

```python
selector = MLSelector(params={
    'mode': 'multi_factor_weighted',
    'top_n': 50,
    'features': 'momentum_20d,rsi_14d',
    'filter_min_price': 10,    # æœ€ä½10å…ƒ
    'filter_max_price': 100,   # æœ€é«˜100å…ƒ
})
```

### è‡ªå®šä¹‰ç‰¹å¾é›†

```python
selector = MLSelector(params={
    'top_n': 50,
    'features': 'momentum_5d,momentum_10d,momentum_20d,momentum_60d,rsi_14d,rsi_28d,volatility_20d,volatility_60d,ma_cross_20d,ma_cross_60d,atr_14d'
})
```

---

## ğŸš€ æ ¸å¿ƒç®—æ³•

### å¤šå› å­åŠ æƒè¯„åˆ†æµç¨‹

```
1. ç‰¹å¾è®¡ç®—
   â”œâ”€â”€ éå†å€™é€‰è‚¡ç¥¨
   â”œâ”€â”€ è®¡ç®—æ¯åªè‚¡ç¥¨çš„ç‰¹å¾å€¼
   â””â”€â”€ æ„å»ºç‰¹å¾çŸ©é˜µ (Nè‚¡ç¥¨ Ã— Mç‰¹å¾)

2. ç‰¹å¾å½’ä¸€åŒ–
   â”œâ”€â”€ Z-score æ ‡å‡†åŒ–: (X - mean) / std
   â””â”€â”€ æ¶ˆé™¤é‡çº²å½±å“

3. è¯„åˆ†èšåˆ
   â”œâ”€â”€ ç­‰æƒå¹³å‡ï¼ˆå¯æ‰©å±•ä¸ºåŠ æƒï¼‰
   â””â”€â”€ å¾—åˆ°æ¯åªè‚¡ç¥¨çš„ç»¼åˆè¯„åˆ†

4. æ’åºé€‰è‚¡
   â”œâ”€â”€ æŒ‰è¯„åˆ†é™åºæ’åº
   â””â”€â”€ é€‰å‡º Top N è‚¡ç¥¨
```

### RSI è®¡ç®—å…¬å¼

```
RSI = 100 - (100 / (1 + RS))
RS = å¹³å‡æ¶¨å¹… / å¹³å‡è·Œå¹…

å…¶ä¸­ï¼š
- å¹³å‡æ¶¨å¹… = period å†…ä¸Šæ¶¨æ—¥æ”¶ç›Šçš„å¹³å‡
- å¹³å‡è·Œå¹… = period å†…ä¸‹è·Œæ—¥æ”¶ç›Šçš„å¹³å‡
```

---

## ğŸ’¡ è®¾è®¡äº®ç‚¹

### 1. æ¨¡å—åŒ–æ¶æ„
- ç‰¹å¾è®¡ç®—ã€è¯„åˆ†ã€æ’åºä¸‰ä¸ªæ¨¡å—ç‹¬ç«‹
- æ˜“äºæ‰©å±•æ–°ç‰¹å¾
- æ”¯æŒè‡ªå®šä¹‰è¯„åˆ†æ¨¡å‹

### 2. å®¹é”™æœºåˆ¶
- è‡ªåŠ¨å¤„ç† NaN å€¼
- æ¨¡å‹åŠ è½½å¤±è´¥è‡ªåŠ¨å›é€€
- æ•°æ®ä¸è¶³æ—¶ä¼˜é›…é™çº§

### 3. å‚æ•°éªŒè¯
- ç»§æ‰¿ StockSelector çš„éªŒè¯æœºåˆ¶
- ç±»å‹æ£€æŸ¥ã€èŒƒå›´æ£€æŸ¥
- æ¸…æ™°çš„é”™è¯¯æç¤º

### 4. æ€§èƒ½ä¼˜åŒ–
- å‘é‡åŒ–è®¡ç®—ï¼ˆpandas/numpyï¼‰
- æ— é¢å¤–ä¾èµ–ï¼ˆé™¤ LightGBM å¯é€‰ï¼‰
- é«˜æ•ˆçš„ç‰¹å¾è®¡ç®—

### 5. æ—¥å¿—è®°å½•
- loguru é›†æˆ
- è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
- ä¾¿äºé—®é¢˜æ’æŸ¥

---

## ğŸ“ æŠ€æœ¯æ ˆ

### æ ¸å¿ƒä¾èµ–
- **pandas** - æ•°æ®å¤„ç†
- **numpy** - æ•°å€¼è®¡ç®—
- **loguru** - æ—¥å¿—è®°å½•

### å¯é€‰ä¾èµ–
- **joblib** - æ¨¡å‹åºåˆ—åŒ–ï¼ˆLightGBMæ¨¡å¼ï¼‰
- **lightgbm** - æ’åºæ¨¡å‹ï¼ˆè¿›é˜¶åŠŸèƒ½ï¼‰
- **scikit-learn** - æœªæ¥æ‰©å±•

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### é€‰è‚¡æ€§èƒ½
- **20åªè‚¡ç¥¨ï¼Œ100å¤©æ•°æ®**: ~10ms
- **100åªè‚¡ç¥¨ï¼Œ252å¤©æ•°æ®**: ~50ms
- **å†…å­˜å ç”¨**: < 100MB

### ç‰¹å¾è®¡ç®—æ•ˆç‡
| ç‰¹å¾æ•°é‡ | è‚¡ç¥¨æ•° | è€—æ—¶ |
|---------|--------|------|
| 3ä¸ª | 20 | ~5ms |
| 11ä¸ª (é»˜è®¤) | 50 | ~20ms |
| 11ä¸ª (é»˜è®¤) | 100 | ~40ms |

---

## ğŸ”„ ä¸ StarRanker å¯¹æ¯”

| ç»´åº¦ | å¤–éƒ¨ StarRanker | Core MLSelector |
|------|----------------|-----------------|
| **éƒ¨ç½²æ–¹å¼** | ç‹¬ç«‹æœåŠ¡ | Core å†…ç½® âœ… |
| **é›†æˆå¤æ‚åº¦** | éœ€ API/DB é›†æˆ | ç›´æ¥è°ƒç”¨ âœ… |
| **æ€§èƒ½** | ç½‘ç»œå»¶è¿Ÿ | æ— å»¶è¿Ÿ âœ… |
| **ç»´æŠ¤æˆæœ¬** | å¤šä¸ªæœåŠ¡ | å•ä¸€ä»£ç åº“ âœ… |
| **çµæ´»æ€§** | å›ºå®šæ¥å£ | å®Œå…¨å¯å®šåˆ¶ âœ… |
| **æ•°æ®å…±äº«** | éœ€ä¼ è¾“ | å†…éƒ¨å…±äº« âœ… |

**ç»“è®º**: MLSelector åœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹ä¼˜äºå¤–éƒ¨ StarRanker é›†æˆã€‚

---

## ğŸ›£ï¸ åç»­æ‰©å±•

### çŸ­æœŸ (1-2å‘¨)
- [ ] **ML-2**: å› å­æƒé‡ä¼˜åŒ–ï¼ˆæ›¿ä»£ç­‰æƒå¹³å‡ï¼‰
- [ ] **ML-3**: LightGBM æ¨¡å‹è®­ç»ƒå·¥å…·
- [ ] **ML-4**: é›†æˆ feature_engineering.py çš„ 125+ å› å­

### ä¸­æœŸ (1ä¸ªæœˆ)
- [ ] æ·»åŠ åŸºæœ¬é¢å› å­ï¼ˆPEã€PBã€ROEï¼‰
- [ ] å¸‚åœºå› å­ï¼ˆå¸‚å€¼ã€æµåŠ¨æ€§ï¼‰
- [ ] å› å­æœ‰æ•ˆæ€§åˆ†æå·¥å…·

### é•¿æœŸ (3ä¸ªæœˆ)
- [ ] å› å­è‡ªåŠ¨ç­›é€‰ï¼ˆç›¸å…³æ€§ã€ICï¼‰
- [ ] å¤šæ¨¡å‹é›†æˆï¼ˆEnsembleï¼‰
- [ ] å®æ—¶é€‰è‚¡ä¼˜åŒ–

---

## ğŸ“ éªŒæ”¶æ ‡å‡†

| æ ‡å‡† | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| MLSelector åŸºç±»å®ç° | âœ… | 783è¡Œï¼ŒåŠŸèƒ½å®Œæ•´ |
| å¤šå› å­åŠ æƒæ¨¡å¼ | âœ… | é»˜è®¤æ¨¡å¼å¯ç”¨ |
| LightGBM æ¨¡å¼æ”¯æŒ | âœ… | æ”¯æŒå¤–éƒ¨æ¨¡å‹ |
| å•å…ƒæµ‹è¯• | âœ… | 46ä¸ªç”¨ä¾‹ï¼Œ100%é€šè¿‡ |
| ä½¿ç”¨ç¤ºä¾‹ | âœ… | 8ä¸ªå®Œæ•´ç¤ºä¾‹ |
| æ–‡æ¡£ | âœ… | æœ¬æ–‡æ¡£ + ä»£ç æ³¨é‡Š |
| ä¸ä¸‰å±‚æ¶æ„é›†æˆ | âœ… | å…¼å®¹ StrategyComposer |

---

## ğŸ‰ æ€»ç»“

**ä»»åŠ¡ ML-1: MLSelector åŸºç±»å®ç°** å·²æˆåŠŸå®Œæˆï¼

### äº¤ä»˜æˆæœ
âœ… æ ¸å¿ƒå®ç°æ–‡ä»¶ 1ä¸ªï¼ˆ783è¡Œï¼‰
âœ… å®Œæ•´å•å…ƒæµ‹è¯• 1ä¸ªï¼ˆ46ä¸ªç”¨ä¾‹ï¼‰
âœ… ä½¿ç”¨ç¤ºä¾‹æ–‡ä»¶ 1ä¸ªï¼ˆ8ä¸ªç¤ºä¾‹ï¼‰
âœ… æŠ€æœ¯æ–‡æ¡£ 1ä»½ï¼ˆæœ¬æ–‡æ¡£ï¼‰

### åŠŸèƒ½äº®ç‚¹
âœ… 11ç§å†…ç½®æŠ€æœ¯ç‰¹å¾
âœ… 3ç§è¯„åˆ†æ¨¡å¼ï¼ˆå¤šå› å­åŠ æƒ/LightGBM/è‡ªå®šä¹‰ï¼‰
âœ… å®Œå–„çš„å‚æ•°éªŒè¯å’Œé”™è¯¯å¤„ç†
âœ… 100% æµ‹è¯•è¦†ç›–å’Œé€šè¿‡ç‡

### æ€§èƒ½è¡¨ç°
âœ… é€‰è‚¡é€Ÿåº¦ < 50msï¼ˆ100åªè‚¡ç¥¨ï¼‰
âœ… å†…å­˜å ç”¨ < 100MB
âœ… æ— é¢å¤–è¿è¡Œæ—¶ä¾èµ–

### å¯ç”¨æ€§
âœ… ä¸ä¸‰å±‚æ¶æ„æ— ç¼é›†æˆ
âœ… å‘åå…¼å®¹ç°æœ‰ä»£ç 
âœ… æ¸…æ™°çš„ä½¿ç”¨æ–‡æ¡£å’Œç¤ºä¾‹

---

**æœ€åæ›´æ–°**: 2026-02-06
**å®ç°è€…**: Claude Code
**çŠ¶æ€**: âœ… å®Œæˆå¹¶æµ‹è¯•é€šè¿‡
