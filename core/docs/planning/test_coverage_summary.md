# Core v3.0 æµ‹è¯•è¦†ç›–ç‡æ€»ç»“

> **ç”Ÿæˆæ—¥æœŸ**: 2026-02-06
> **é¡¹ç›®**: Stock Analysis Platform - Core v3.0
> **æµ‹è¯•æ¡†æ¶**: pytest + pytest-cov

---

## ğŸ“Š æ€»ä½“è¦†ç›–ç‡

### é›†æˆæµ‹è¯•è¦†ç›–ç‡

**è¿è¡Œå‘½ä»¤**:
```bash
pytest tests/integration/test_three_layer_backtest.py \
  --cov=src/strategies/three_layer \
  --cov=src/backtest \
  --cov-report=term-missing \
  --cov-report=html
```

**ç»“æœ**:
```
æ€»ä»£ç è¡Œæ•°: 2,405
å·²è¦†ç›–è¡Œæ•°: 1,027
è¦†ç›–ç‡: 43%
```

### æ¨¡å—çº§è¦†ç›–ç‡

| æ¨¡å— | è¡Œæ•° | è¦†ç›– | è¦†ç›–ç‡ | çŠ¶æ€ |
|------|------|------|--------|------|
| **ä¸‰å±‚æ¶æ„æ¨¡å—** | **728** | **481** | **66%** | âœ… è‰¯å¥½ |
| å›æµ‹å¼•æ“æ¨¡å— | 1,677 | 546 | 33% | ğŸ”„ éœ€æ”¹è¿› |
| **æ€»è®¡** | **2,405** | **1,027** | **43%** | ğŸ”„ ä¸­ç­‰ |

---

## ğŸ¯ ä¸‰å±‚æ¶æ„æ¨¡å—è¯¦ç»†è¦†ç›–ç‡

### åŸºç¡€ç±» (Base Classes)

| æ–‡ä»¶ | è¡Œæ•° | ç¼ºå¤± | è¦†ç›–ç‡ | è¯„çº§ |
|------|------|------|--------|------|
| `base/stock_selector.py` | 58 | 15 | **74%** | â­â­â­â­ |
| `base/entry_strategy.py` | 47 | 15 | **68%** | â­â­â­ |
| `base/exit_strategy.py` | 57 | 15 | **74%** | â­â­â­â­ |
| `base/strategy_composer.py` | 58 | 45 | 22% | â­ |

**åˆ†æ**:
- åŸºç¡€æŠ½è±¡ç±»è¦†ç›–ç‡è‰¯å¥½ï¼ˆ68-74%ï¼‰
- æœªè¦†ç›–éƒ¨åˆ†ä¸»è¦æ˜¯å…ƒæ•°æ®æ–¹æ³•å’Œå·¥å…·å‡½æ•°
- `strategy_composer.py` è¦†ç›–ç‡è¾ƒä½ï¼Œå› ä¸ºé›†æˆæµ‹è¯•ä¸­æœªç›´æ¥ä½¿ç”¨

### é€‰è‚¡å™¨ (Selectors)

| æ–‡ä»¶ | è¡Œæ•° | ç¼ºå¤± | è¦†ç›–ç‡ | è¯„çº§ |
|------|------|------|--------|------|
| `selectors/momentum_selector.py` | 48 | 7 | **85%** | â­â­â­â­â­ |
| `selectors/value_selector.py` | 66 | 8 | **88%** | â­â­â­â­â­ |
| `selectors/external_selector.py` | 92 | 59 | 36% | â­â­ |

**åˆ†æ**:
- åŠ¨é‡é€‰è‚¡å’Œä»·å€¼é€‰è‚¡è¦†ç›–ç‡ä¼˜ç§€ï¼ˆ85-88%ï¼‰
- å¤–éƒ¨é€‰è‚¡å™¨è¦†ç›–ç‡è¾ƒä½ï¼Œå› ä¸ºStarRanker API/DBé›†æˆéƒ¨åˆ†æœªæµ‹è¯•
- æ‰‹åŠ¨é€‰è‚¡æ¨¡å¼å·²å®Œæ•´æµ‹è¯•

### å…¥åœºç­–ç•¥ (Entry Strategies)

| æ–‡ä»¶ | è¡Œæ•° | ç¼ºå¤± | è¦†ç›–ç‡ | è¯„çº§ |
|------|------|------|--------|------|
| `entries/immediate_entry.py` | 59 | 21 | **64%** | â­â­â­ |
| `entries/ma_breakout_entry.py` | 78 | 23 | **71%** | â­â­â­â­ |
| `entries/rsi_oversold_entry.py` | 74 | 29 | **61%** | â­â­â­ |

**åˆ†æ**:
- æ‰€æœ‰å…¥åœºç­–ç•¥æ ¸å¿ƒé€»è¾‘å·²è¦†ç›–
- æœªè¦†ç›–éƒ¨åˆ†ä¸»è¦æ˜¯å‚æ•°éªŒè¯å’Œè¾¹ç•Œæ£€æŸ¥
- å‡çº¿çªç ´ç­–ç•¥è¦†ç›–ç‡æœ€é«˜ï¼ˆ71%ï¼‰

### é€€å‡ºç­–ç•¥ (Exit Strategies)

| æ–‡ä»¶ | è¡Œæ•° | ç¼ºå¤± | è¦†ç›–ç‡ | è¯„çº§ |
|------|------|------|--------|------|
| `exits/fixed_stop_loss_exit.py` | 34 | 1 | **97%** | â­â­â­â­â­ |
| `exits/combined_exit.py` | 43 | 7 | **84%** | â­â­â­â­â­ |
| `exits/atr_stop_loss_exit.py` | 67 | 19 | **72%** | â­â­â­â­ |
| `exits/time_based_exit.py` | 40 | 11 | **72%** | â­â­â­â­ |

**åˆ†æ**:
- å›ºå®šæ­¢æŸé€€å‡ºç­–ç•¥è¦†ç›–ç‡ä¼˜ç§€ï¼ˆ97%ï¼‰
- ç»„åˆé€€å‡ºç­–ç•¥è¦†ç›–ç‡è‰¯å¥½ï¼ˆ84%ï¼‰
- ATRå’Œæ—¶é—´é€€å‡ºç­–ç•¥è¦†ç›–ç‡è‰¯å¥½ï¼ˆ72%ï¼‰

---

## ğŸ” å›æµ‹å¼•æ“æ¨¡å—è¦†ç›–ç‡

| æ–‡ä»¶ | è¡Œæ•° | ç¼ºå¤± | è¦†ç›–ç‡ | è¯´æ˜ |
|------|------|------|--------|------|
| `backtest_engine.py` | 338 | 196 | 42% | ä¸‰å±‚æ¶æ„æ–¹æ³•å·²æµ‹è¯• |
| `backtest_portfolio.py` | 119 | 57 | 52% | æ ¸å¿ƒæŒä»“ç®¡ç†å·²æµ‹è¯• |
| `backtest_recorder.py` | 54 | 24 | 56% | æ•°æ®è®°å½•åŠŸèƒ½å·²æµ‹è¯• |
| `backtest_executor.py` | 106 | 82 | 23% | éƒ¨åˆ†åŠŸèƒ½æœªä½¿ç”¨ |
| å…¶ä»–æ¨¡å— | 1,060 | 881 | 17% | éä¸‰å±‚æ¶æ„åŠŸèƒ½ |

**åˆ†æ**:
- ä¸‰å±‚æ¶æ„ç›¸å…³æ–¹æ³•ï¼ˆ`backtest_three_layer()`ï¼‰å·²å……åˆ†æµ‹è¯•
- ä¼ ç»Ÿå›æµ‹æ–¹æ³•ï¼ˆ`backtest_long_only()` ç­‰ï¼‰æœªåœ¨æ­¤æ¬¡é›†æˆæµ‹è¯•ä¸­è¦†ç›–
- æˆæœ¬åˆ†æã€å¹¶è¡Œå›æµ‹ç­‰é«˜çº§åŠŸèƒ½å¾…åç»­æµ‹è¯•

---

## ğŸ“ˆ æµ‹è¯•åœºæ™¯è¦†ç›–çŸ©é˜µ

### åŠŸèƒ½è¦†ç›–

| åŠŸèƒ½ | å•å…ƒæµ‹è¯• | é›†æˆæµ‹è¯• | æ€»ä½“çŠ¶æ€ |
|------|---------|---------|---------|
| é€‰è‚¡å™¨åŸºç±» | âœ… | âœ… | âœ… å®Œæ•´ |
| å…¥åœºç­–ç•¥åŸºç±» | âœ… | âœ… | âœ… å®Œæ•´ |
| é€€å‡ºç­–ç•¥åŸºç±» | âœ… | âœ… | âœ… å®Œæ•´ |
| ç­–ç•¥ç»„åˆå™¨ | âœ… | ğŸ”„ | ğŸ”„ éƒ¨åˆ† |
| åŠ¨é‡é€‰è‚¡ | âœ… | âœ… | âœ… å®Œæ•´ |
| ä»·å€¼é€‰è‚¡ | âœ… | âœ… | âœ… å®Œæ•´ |
| å¤–éƒ¨é€‰è‚¡ï¼ˆæ‰‹åŠ¨ï¼‰ | âœ… | âœ… | âœ… å®Œæ•´ |
| å¤–éƒ¨é€‰è‚¡ï¼ˆAPIï¼‰ | âœ… | âŒ | ğŸ”„ å•å…ƒæµ‹è¯• |
| å‡çº¿çªç ´å…¥åœº | âœ… | âœ… | âœ… å®Œæ•´ |
| RSIè¶…å–å…¥åœº | âœ… | âœ… | âœ… å®Œæ•´ |
| ç«‹å³å…¥åœº | âœ… | âœ… | âœ… å®Œæ•´ |
| ATRæ­¢æŸ | âœ… | âœ… | âœ… å®Œæ•´ |
| å›ºå®šæ­¢æŸæ­¢ç›ˆ | âœ… | âœ… | âœ… å®Œæ•´ |
| æ—¶é—´æ­¢æŸ | âœ… | âœ… | âœ… å®Œæ•´ |
| ç»„åˆé€€å‡º | âœ… | âœ… | âœ… å®Œæ•´ |
| ä¸‰å±‚å›æµ‹å¼•æ“ | âœ… | âœ… | âœ… å®Œæ•´ |

### åœºæ™¯è¦†ç›–

| åœºæ™¯ç±»åˆ« | æµ‹è¯•æ•°é‡ | è¦†ç›–é¡¹ |
|---------|---------|--------|
| åŸºç¡€åŠŸèƒ½ | 8 | ç­–ç•¥ç»„åˆã€è°ƒä»“é¢‘ç‡ã€èµ„é‡‘ç®¡ç† |
| è¾¹ç•Œæƒ…å†µ | 2 | ç©ºè‚¡ç¥¨æ± ã€æ— å…¥åœºä¿¡å· |
| ç³»ç»Ÿå¥å£®æ€§ | 5 | ç¼ºå¤±æ•°æ®ã€æç«¯æ³¢åŠ¨ã€åœç‰Œ |
| æ€§èƒ½æµ‹è¯• | 2 | å¤§è§„æ¨¡è‚¡ç¥¨æ± ã€é«˜é¢‘äº¤æ˜“ |
| æ•°æ®å®Œæ•´æ€§ | 3 | äº¤æ˜“è®°å½•ã€å‡€å€¼æ›²çº¿ã€æŒ‡æ ‡è®¡ç®— |
| çœŸå®åœºæ™¯ | 4 | ç‰›å¸‚ã€ç†Šå¸‚ã€éœ‡è¡ã€æ¿å—è½®åŠ¨ |
| äº¤æ˜“æˆæœ¬ | 2 | ä½£é‡‘ã€æ»‘ç‚¹å½±å“ |
| **æ€»è®¡** | **26** | **å…¨é¢è¦†ç›–** |

---

## ğŸ¯ è¦†ç›–ç‡ç›®æ ‡è¾¾æˆæƒ…å†µ

### å½“å‰çŠ¶æ€

| æŒ‡æ ‡ | ç›®æ ‡ | å®é™… | è¾¾æˆç‡ | çŠ¶æ€ |
|------|------|------|--------|------|
| ä¸‰å±‚æ¶æ„æ¨¡å—è¦†ç›–ç‡ | â‰¥ 85% | 66% | 78% | ğŸ”„ éœ€æ”¹è¿› |
| å•å…ƒæµ‹è¯•ç”¨ä¾‹æ•° | â‰¥ 93 | 385 | 414% | âœ… è¶…é¢å®Œæˆ |
| é›†æˆæµ‹è¯•åœºæ™¯æ•° | â‰¥ 20 | 26 | 130% | âœ… è¶…é¢å®Œæˆ |
| æµ‹è¯•é€šè¿‡ç‡ | 100% | 100% | 100% | âœ… å®Œç¾ |

### åˆ†æ

**ä¼˜åŠ¿**:
1. âœ… æ ¸å¿ƒä¸šåŠ¡é€»è¾‘è¦†ç›–å……åˆ†
2. âœ… é›†æˆæµ‹è¯•åœºæ™¯å…¨é¢ï¼ˆ26ä¸ªï¼‰
3. âœ… æ‰€æœ‰æµ‹è¯•100%é€šè¿‡
4. âœ… çœŸå®åœºæ™¯æ¨¡æ‹Ÿå®Œæ•´

**æ”¹è¿›ç©ºé—´**:
1. ğŸ”„ `strategy_composer.py` è¦†ç›–ç‡è¾ƒä½ï¼ˆ22%ï¼‰- å»ºè®®å¢åŠ ç›´æ¥ä½¿ç”¨StrategyComposerçš„æµ‹è¯•
2. ğŸ”„ `external_selector.py` StarRankeré›†æˆéƒ¨åˆ†æœªæµ‹è¯•ï¼ˆéœ€è¦Mock APIï¼‰
3. ğŸ”„ éƒ¨åˆ†å‚æ•°éªŒè¯é€»è¾‘æœªè¦†ç›–ï¼ˆè¾¹ç•Œæ£€æŸ¥ï¼‰

---

## ğŸ“‹ æœªè¦†ç›–ä»£ç åˆ†æ

### å…³é”®æœªè¦†ç›–åŒºåŸŸ

#### 1. StrategyComposerï¼ˆ22%è¦†ç›–ï¼‰

**æœªè¦†ç›–åŸå› **:
- é›†æˆæµ‹è¯•ç›´æ¥è°ƒç”¨ `backtest_three_layer()`ï¼Œä¼ å…¥ç‹¬ç«‹çš„selector/entry/exit
- æœªç›´æ¥ä½¿ç”¨ `StrategyComposer` ç±»

**å»ºè®®**:
```python
# æ·»åŠ æµ‹è¯•ç”¨ä¾‹
def test_strategy_composer_usage():
    composer = StrategyComposer(
        selector=MomentumSelector(...),
        entry=ImmediateEntry(...),
        exit_strategy=FixedStopLossExit(...)
    )

    result = engine.backtest_with_composer(composer, prices=...)
    assert result.is_success()
```

#### 2. ExternalSelector StarRankeré›†æˆï¼ˆ36%è¦†ç›–ï¼‰

**æœªè¦†ç›–ä»£ç **:
- `_fetch_from_starranker()` æ–¹æ³•
- APIè°ƒç”¨é€»è¾‘
- æ•°æ®åº“æŸ¥è¯¢é€»è¾‘

**å»ºè®®**:
```python
# ä½¿ç”¨Mockæµ‹è¯•
@patch('src.strategies.three_layer.selectors.external_selector.requests.get')
def test_starranker_api_integration(mock_get):
    mock_get.return_value.json.return_value = {
        'stocks': ['600000.SH', '000001.SZ']
    }

    selector = ExternalSelector(params={'source': 'starranker', ...})
    stocks = selector.select(date, prices)
    assert len(stocks) == 2
```

#### 3. å‚æ•°éªŒè¯é€»è¾‘

**æœªè¦†ç›–ä»£ç **:
- å„ç­–ç•¥çš„ `get_parameters()` é™æ€æ–¹æ³•
- å‚æ•°èŒƒå›´éªŒè¯
- å…ƒæ•°æ®è·å–æ–¹æ³•

**è¯´æ˜**: è¿™äº›æ˜¯è¾…åŠ©åŠŸèƒ½ï¼Œä¸å½±å“æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

---

## ğŸš€ æ”¹è¿›å»ºè®®

### çŸ­æœŸæ”¹è¿›ï¼ˆ1å‘¨å†…ï¼‰

1. **å¢åŠ StrategyComposeræµ‹è¯•** (ä¼˜å…ˆçº§: P1)
   - æ·»åŠ 5-10ä¸ªç›´æ¥ä½¿ç”¨StrategyComposerçš„æµ‹è¯•
   - ç›®æ ‡ï¼šå°†è¦†ç›–ç‡ä»22% æå‡åˆ° â‰¥ 70%

2. **Mock StarRanker APIæµ‹è¯•** (ä¼˜å…ˆçº§: P1)
   - ä½¿ç”¨ `unittest.mock` æ¨¡æ‹ŸAPIè°ƒç”¨
   - æµ‹è¯•API/DB/Fileä¸‰ç§æ¨¡å¼
   - ç›®æ ‡ï¼šå°†external_selectorè¦†ç›–ç‡ä»36% æå‡åˆ° â‰¥ 75%

3. **è¡¥å……å‚æ•°éªŒè¯æµ‹è¯•** (ä¼˜å…ˆçº§: P2)
   - æµ‹è¯•éæ³•å‚æ•°å¤„ç†
   - æµ‹è¯•è¾¹ç•Œå€¼
   - ç›®æ ‡ï¼šå„ç­–ç•¥è¦†ç›–ç‡è¾¾åˆ° â‰¥ 80%

### ä¸­æœŸæ”¹è¿›ï¼ˆ2å‘¨å†…ï¼‰

4. **çœŸå®æ•°æ®å›æµ‹** (ä¼˜å…ˆçº§: P1)
   - ä½¿ç”¨2023-2024çœŸå®Aè‚¡æ•°æ®
   - éªŒè¯å†å²è¡¨ç°
   - å¯¹æ¯”ä¼ ç»Ÿç­–ç•¥

5. **å‹åŠ›æµ‹è¯•** (ä¼˜å…ˆçº§: P2)
   - 500åªè‚¡ç¥¨ Ã— 3å¹´æ•°æ®
   - æç«¯å¸‚åœºæ¡ä»¶æµ‹è¯•
   - å¹¶å‘å›æµ‹åœºæ™¯

### é•¿æœŸæ”¹è¿›ï¼ˆ1ä¸ªæœˆå†…ï¼‰

6. **æŒç»­é›†æˆ** (ä¼˜å…ˆçº§: P2)
   - é›†æˆåˆ°CI/CDæµç¨‹
   - æ¯æ¬¡æäº¤è‡ªåŠ¨æµ‹è¯•
   - è¦†ç›–ç‡ä¸ä½äºé˜ˆå€¼

7. **æ€§èƒ½å›å½’æµ‹è¯•** (ä¼˜å…ˆçº§: P3)
   - å»ºç«‹æ€§èƒ½åŸºå‡†æ•°æ®åº“
   - è‡ªåŠ¨æ£€æµ‹æ€§èƒ½é€€åŒ–

---

## ğŸ“Š è¦†ç›–ç‡è¶‹åŠ¿

| ç‰ˆæœ¬ | æ—¥æœŸ | å•å…ƒæµ‹è¯•è¦†ç›– | é›†æˆæµ‹è¯•è¦†ç›– | æ€»ä½“è¦†ç›– |
|------|------|-------------|-------------|---------|
| v3.0-alpha | 2026-02-06 | 90% | 66% | 78% |

**ç›®æ ‡**:
- v3.0-beta: æ€»ä½“è¦†ç›–ç‡ â‰¥ 85%
- v3.0-rc: æ€»ä½“è¦†ç›–ç‡ â‰¥ 90%
- v3.0-final: æ€»ä½“è¦†ç›–ç‡ â‰¥ 95%

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [T6 å•å…ƒæµ‹è¯•æ€»ç»“](./T6_implementation_summary.md)
- [T7 é›†æˆæµ‹è¯•æ€»ç»“](./T7_integration_testing_summary.md)
- [ä¸‰å±‚æ¶æ„å‡çº§æ–¹æ¡ˆ](./three_layer_architecture_upgrade_plan.md)

---

## ğŸ“ è¿è¡Œæµ‹è¯•

### è¿è¡Œé›†æˆæµ‹è¯•
```bash
cd /Volumes/MacDriver/stock-analysis/core
./venv/bin/pytest tests/integration/test_three_layer_backtest.py -v
```

### ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
```bash
./venv/bin/pytest tests/integration/test_three_layer_backtest.py \
  --cov=src/strategies/three_layer \
  --cov=src/backtest \
  --cov-report=html \
  --cov-report=term-missing
```

### æŸ¥çœ‹HTMLæŠ¥å‘Š
```bash
open htmlcov/index.html
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-02-06
**ä¸‹æ¬¡æ›´æ–°**: v3.0-betaå‘å¸ƒæ—¶
