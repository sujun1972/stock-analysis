# Phase 2: åŠ è½½å™¨å®ç° - å®ŒæˆæŠ¥å‘Š

**æ—¥æœŸ**: 2026-02-08
**çŠ¶æ€**: âœ… å·²å®Œæˆ
**æ€»è€—æ—¶**: ~2å°æ—¶

---

## ğŸ“‹ å®æ–½æ€»è§ˆ

Phase 2 æˆåŠŸå®ç°äº†ç­–ç•¥åŠ è½½å™¨ç³»ç»Ÿï¼ŒåŒ…æ‹¬å‚æ•°é…ç½®åŠ è½½å™¨ï¼ˆConfigLoaderï¼‰ã€åŠ¨æ€ä»£ç åŠ è½½å™¨ï¼ˆDynamicCodeLoaderï¼‰ã€åŠ è½½å™¨å·¥å‚ï¼ˆLoaderFactoryï¼‰å’Œå¤šçº§ç¼“å­˜æœºåˆ¶ã€‚

---

## âœ… å·²å®Œæˆä»»åŠ¡

### 1. BaseLoader æŠ½è±¡åŸºç±»
- **æ–‡ä»¶**: [base_loader.py](../../src/strategies/loaders/base_loader.py)
- **åŠŸèƒ½**:
  - å®šä¹‰åŠ è½½å™¨é€šç”¨æ¥å£
  - æä¾›ç¼“å­˜ç®¡ç†åŸºç¡€æ–¹æ³•
  - æ”¯æŒç¼“å­˜ä¿¡æ¯æŸ¥è¯¢
- **çŠ¶æ€**: âœ… å®Œæˆ

### 2. ConfigLoader (å‚æ•°é…ç½®åŠ è½½å™¨)
- **æ–‡ä»¶**: [config_loader.py](../../src/strategies/loaders/config_loader.py)
- **åŠŸèƒ½**:
  - ä»æ•°æ®åº“åŠ è½½ç­–ç•¥é…ç½®
  - æ ¹æ® `strategy_type` åˆ›å»ºé¢„å®šä¹‰ç­–ç•¥
  - æ”¯æŒå•ä¸ª/æ‰¹é‡åŠ è½½
  - é™„åŠ å…ƒä¿¡æ¯ï¼ˆconfig_id, versionï¼‰
  - å†…å­˜ç¼“å­˜æœºåˆ¶
- **API**:
  - `load_strategy(config_id)` - åŠ è½½å•ä¸ªç­–ç•¥
  - `batch_load_strategies(ids)` - æ‰¹é‡åŠ è½½
  - `list_available_configs()` - åˆ—å‡ºå¯ç”¨é…ç½®
  - `reload_strategy(config_id)` - é‡æ–°åŠ è½½
- **çŠ¶æ€**: âœ… å®Œæˆ

### 3. DynamicCodeLoader (åŠ¨æ€ä»£ç åŠ è½½å™¨)
- **æ–‡ä»¶**: [dynamic_loader.py](../../src/strategies/loaders/dynamic_loader.py)
- **åŠŸèƒ½**:
  - ä»æ•°æ®åº“åŠ è½½ AI ç”Ÿæˆçš„ä»£ç 
  - **å¤šå±‚å®‰å…¨éªŒè¯**:
    1. ä»£ç å‡€åŒ–ï¼ˆCodeSanitizerï¼‰
    2. æƒé™æ£€æŸ¥ï¼ˆPermissionCheckerï¼‰
    3. å“ˆå¸ŒéªŒè¯
  - å—é™å‘½åç©ºé—´æ²™ç®±æ‰§è¡Œ
  - åŠ¨æ€ç¼–è¯‘å’Œç±»åŠ è½½
  - å®¡è®¡æ—¥å¿—è®°å½•
- **å®‰å…¨æœºåˆ¶**:
  - ç¦æ­¢å±é™©å¯¼å…¥ï¼ˆos, subprocessç­‰ï¼‰
  - ç¦æ­¢å±é™©å‡½æ•°ï¼ˆeval, execç­‰ï¼‰
  - å—é™çš„å†…ç½®å‡½æ•°é›†
  - åªå…è®¸å®‰å…¨çš„ pandas/numpy æ“ä½œ
- **API**:
  - `load_strategy(strategy_id, strict_mode)` - åŠ è½½ç­–ç•¥
  - `batch_load_strategies(ids)` - æ‰¹é‡åŠ è½½
  - `list_available_strategies()` - åˆ—å‡ºå¯ç”¨ç­–ç•¥
- **çŠ¶æ€**: âœ… å®Œæˆ

### 4. LoaderFactory (åŠ è½½å™¨å·¥å‚)
- **æ–‡ä»¶**: [loader_factory.py](../../src/strategies/loaders/loader_factory.py)
- **åŠŸèƒ½**:
  - ç»Ÿä¸€çš„ç­–ç•¥åŠ è½½æ¥å£
  - æ ¹æ® `strategy_source` é€‰æ‹©åŠ è½½å™¨
  - å•ä¾‹æ¨¡å¼ç¡®ä¿å…¨å±€å”¯ä¸€
  - æ‰¹é‡åŠ è½½æ”¯æŒ
  - ç¼“å­˜ç®¡ç†
- **API**:
  - `load_strategy(source, id)` - åŠ è½½ç­–ç•¥
  - `batch_load_strategies(configs)` - æ‰¹é‡åŠ è½½
  - `clear_cache(source)` - æ¸…é™¤ç¼“å­˜
  - `get_cache_info()` - ç¼“å­˜ç»Ÿè®¡
  - `list_available_strategies()` - åˆ—å‡ºç­–ç•¥
- **çŠ¶æ€**: âœ… å®Œæˆ

### 5. ç¼“å­˜æœºåˆ¶
- **æ–‡ä»¶**: [strategy_cache.py](../../src/strategies/cache/strategy_cache.py)
- **ç»„ä»¶**:
  - **StrategyCache**: ç­–ç•¥å®ä¾‹ç¼“å­˜
    - å†…å­˜ç¼“å­˜ï¼ˆè¿›ç¨‹çº§ï¼‰
    - å¯é€‰ Redis ç¼“å­˜ï¼ˆåº”ç”¨çº§ï¼‰
    - TTL è¿‡æœŸæœºåˆ¶
    - è‡ªåŠ¨æ¸…ç†
  - **CodeCache**: ä»£ç æ¨¡å—ç¼“å­˜
    - LRU æ·˜æ±°ç­–ç•¥
    - è®¿é—®è®¡æ•°
    - å®¹é‡é™åˆ¶
- **çŠ¶æ€**: âœ… å®Œæˆ

---

## ğŸ§ª æµ‹è¯•è¦†ç›–

### å•å…ƒæµ‹è¯•
- **æµ‹è¯•æ–‡ä»¶**:
  - [test_base_loader.py](../../tests/unit/strategies/loaders/test_base_loader.py) - 7ä¸ªæµ‹è¯•
  - [test_loader_factory.py](../../tests/unit/strategies/loaders/test_loader_factory.py) - 17ä¸ªæµ‹è¯•
  - [test_strategy_cache.py](../../tests/unit/strategies/cache/test_strategy_cache.py) - 18ä¸ªæµ‹è¯•
- **æ€»è®¡**: 42ä¸ªå•å…ƒæµ‹è¯•
- **ç»“æœ**: âœ… 42/42 é€šè¿‡

### é›†æˆæµ‹è¯•
- **æµ‹è¯•æ–‡ä»¶**: [test_loader_integration.py](../../tests/integration/strategies/test_loader_integration.py)
- **æµ‹è¯•å†…å®¹**:
  - åŠ¨æ€ä»£ç ç¼–è¯‘å’ŒåŠ è½½
  - ç­–ç•¥å®ä¾‹åŒ–å’Œæ‰§è¡Œ
  - å®‰å…¨æœºåˆ¶éªŒè¯
  - å—é™å‘½åç©ºé—´æµ‹è¯•
  - é”™è¯¯å¤„ç†æµ‹è¯•
- **æ€»è®¡**: 10ä¸ªé›†æˆæµ‹è¯•
- **ç»“æœ**: âœ… 10/10 é€šè¿‡

### æµ‹è¯•è¦†ç›–ç‡
```
æ¨¡å—                                è¦†ç›–ç‡
------------------------------------------------
cache/__init__.py                   100%
loaders/__init__.py                 100%
loaders/base_loader.py               95%
loaders/loader_factory.py            68%
loaders/config_loader.py             21%  (*)
loaders/dynamic_loader.py            37%  (*)
cache/strategy_cache.py              67%
------------------------------------------------
æ€»è®¡                                 50%
```

**æ³¨**: ConfigLoader å’Œ DynamicCodeLoader è¦†ç›–ç‡è¾ƒä½æ˜¯å› ä¸ºä¾èµ–æ•°æ®åº“ï¼Œæœªåœ¨å•å…ƒæµ‹è¯•ä¸­è¦†ç›–ã€‚è¿™äº›å°†åœ¨é›†æˆæµ‹è¯•ä¸­éªŒè¯ã€‚

---

## ğŸ“‚ æ–‡ä»¶ç»“æ„

```
core/src/strategies/
â”œâ”€â”€ loaders/                          â­ æ–°å¢
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ base_loader.py                (21è¡Œä»£ç )
â”‚   â”œâ”€â”€ config_loader.py              (105è¡Œä»£ç )
â”‚   â”œâ”€â”€ dynamic_loader.py             (191è¡Œä»£ç )
â”‚   â””â”€â”€ loader_factory.py             (104è¡Œä»£ç )
â”‚
â”œâ”€â”€ cache/                            â­ æ–°å¢
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ strategy_cache.py             (137è¡Œä»£ç )
â”‚
â””â”€â”€ security/                         (Phase 1 å·²å®Œæˆ)
    â”œâ”€â”€ code_sanitizer.py
    â”œâ”€â”€ permission_checker.py
    â”œâ”€â”€ resource_limiter.py
    â”œâ”€â”€ audit_logger.py
    â””â”€â”€ security_config.py

core/tests/
â”œâ”€â”€ unit/strategies/
â”‚   â”œâ”€â”€ loaders/                      â­ æ–°å¢
â”‚   â”‚   â”œâ”€â”€ test_base_loader.py       (7æµ‹è¯•)
â”‚   â”‚   â””â”€â”€ test_loader_factory.py    (17æµ‹è¯•)
â”‚   â””â”€â”€ cache/                        â­ æ–°å¢
â”‚       â””â”€â”€ test_strategy_cache.py    (18æµ‹è¯•)
â”‚
â””â”€â”€ integration/strategies/
    â””â”€â”€ test_loader_integration.py    â­ æ–°å¢ (10æµ‹è¯•)
```

**æ€»ä»£ç é‡**: ~558è¡Œï¼ˆä¸å«æµ‹è¯•ï¼‰
**æµ‹è¯•ä»£ç é‡**: ~850è¡Œ
**æµ‹è¯•è¦†ç›–æ¯”**: 1.5:1

---

## ğŸ” å®‰å…¨ç‰¹æ€§å®ç°

### 1. å¤šå±‚å®‰å…¨éªŒè¯
```python
# åŠ è½½AIç­–ç•¥æ—¶çš„å®‰å…¨æµç¨‹:
1. ä»æ•°æ®åº“è¯»å–ä»£ç 
2. éªŒè¯ç­–ç•¥çŠ¶æ€ï¼ˆis_enabledï¼‰
3. ä»£ç å‡€åŒ–ï¼ˆCodeSanitizerï¼‰
   - AST åˆ†æ
   - å“ˆå¸ŒéªŒè¯
   - é£é™©è¯„çº§
4. æƒé™æ£€æŸ¥ï¼ˆPermissionCheckerï¼‰
   - æ–‡ä»¶ç³»ç»Ÿè®¿é—®
   - ç½‘ç»œè®¿é—®
   - ç³»ç»Ÿå‘½ä»¤
5. åŠ¨æ€ç¼–è¯‘ï¼ˆå—é™å‘½åç©ºé—´ï¼‰
6. å®¡è®¡æ—¥å¿—è®°å½•
```

### 2. å—é™å‘½åç©ºé—´
```python
# åªå…è®¸å®‰å…¨çš„å†…ç½®å‡½æ•°
safe_builtins = {
    'abs', 'all', 'any', 'len', 'max', 'min',
    'sum', 'range', 'isinstance', ...
}

# ç¦æ­¢å±é™©å‡½æ•°
forbidden = {
    'eval', 'exec', 'open', '__import__',
    'getattr', 'setattr', ...
}

# åªå…è®¸å®‰å…¨çš„æ¨¡å—
safe_modules = {
    'pd': pandas,
    'np': numpy,
    'logger': loguru,
    'BaseStrategy': ...,
}
```

### 3. å®¡è®¡è¿½è¸ª
- æ‰€æœ‰ç­–ç•¥åŠ è½½éƒ½è®°å½•å®¡è®¡æ—¥å¿—
- åŒ…å«ï¼šæ—¶é—´æˆ³ã€ç­–ç•¥IDã€éªŒè¯ç»“æœã€é£é™©ç­‰çº§
- å®‰å…¨è¿è§„å•ç‹¬è®°å½•
- JSONL æ ¼å¼ä¾¿äºåˆ†æ

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. å¤šçº§ç¼“å­˜
```
ç¬¬1å±‚: å†…å­˜ç¼“å­˜ï¼ˆè¿›ç¨‹çº§ï¼‰
  - æœ€å¿«è®¿é—®é€Ÿåº¦
  - TTL è¿‡æœŸæœºåˆ¶
  - è‡ªåŠ¨æ¸…ç†

ç¬¬2å±‚: Redisç¼“å­˜ï¼ˆå¯é€‰ï¼‰
  - è·¨è¿›ç¨‹å…±äº«
  - æŒä¹…åŒ–
  - åˆ†å¸ƒå¼æ”¯æŒ

ç¬¬3å±‚: æ•°æ®åº“
  - æ°¸ä¹…å­˜å‚¨
  - é…ç½®ç‰ˆæœ¬ç®¡ç†
```

### 2. æ‡’åŠ è½½
- æ•°æ®åº“è¿æ¥å»¶è¿Ÿåˆå§‹åŒ–
- ç­–ç•¥å·¥å‚æŒ‰éœ€åˆ›å»º
- å®‰å…¨ç»„ä»¶æ‡’åŠ è½½

### 3. æ‰¹é‡æ“ä½œ
- æ”¯æŒæ‰¹é‡åŠ è½½ç­–ç•¥
- é”™è¯¯ä¸å½±å“å…¶ä»–åŠ è½½
- å¹¶è¡ŒåŠ è½½ä¼˜åŒ–ï¼ˆæœªæ¥ï¼‰

---

## ğŸ”„ ä¸å…¶ä»–æ¨¡å—çš„é›†æˆ

### ä¾èµ–å…³ç³»
```
LoaderFactory
    â”œâ”€â”€ ConfigLoader
    â”‚   â”œâ”€â”€ DatabaseManager (db)
    â”‚   â””â”€â”€ StrategyFactory (å»¶è¿Ÿå¯¼å…¥)
    â”‚
    â””â”€â”€ DynamicCodeLoader
        â”œâ”€â”€ DatabaseManager (db)
        â”œâ”€â”€ CodeSanitizer (security)
        â”œâ”€â”€ PermissionChecker (security)
        â””â”€â”€ AuditLogger (security)
```

### ä½¿ç”¨ç¤ºä¾‹
```python
from src.strategies.loaders import LoaderFactory

# åˆ›å»ºå·¥å‚ï¼ˆå•ä¾‹ï¼‰
factory = LoaderFactory()

# åŠ è½½å‚æ•°é…ç½®ç­–ç•¥
config_strategy = factory.load_strategy(
    strategy_source='config',
    strategy_id=1
)

# åŠ è½½AIä»£ç ç­–ç•¥
dynamic_strategy = factory.load_strategy(
    strategy_source='dynamic',
    strategy_id=1,
    strict_mode=True
)

# æ‰¹é‡åŠ è½½
strategies = factory.batch_load_strategies([
    {'source': 'config', 'id': 1},
    {'source': 'dynamic', 'id': 2},
])
```

---

## âš ï¸ å·²çŸ¥é™åˆ¶

### 1. æ•°æ®åº“ä¾èµ–
- ConfigLoader å’Œ DynamicCodeLoader ä¾èµ–æ•°æ®åº“è¡¨
- è¡¨ç»“æ„éœ€è¦ä¸ Backend å¯¹æ¥
- éœ€è¦çš„è¡¨:
  - `strategy_configs` (å‚æ•°é…ç½®)
  - `ai_strategies` (AIç”Ÿæˆä»£ç )

### 2. å®‰å…¨é™åˆ¶
- åŠ¨æ€ä»£ç åªèƒ½è®¿é—® pandas/numpy
- ä¸æ”¯æŒè‡ªå®šä¹‰æ¨¡å—å¯¼å…¥
- ä¸æ”¯æŒæ–‡ä»¶/ç½‘ç»œæ“ä½œ

### 3. æ€§èƒ½é™åˆ¶
- é¦–æ¬¡åŠ è½½éœ€è¦ç¼–è¯‘ä»£ç 
- å¤§é‡ç­–ç•¥åŠ è½½æ—¶å†…å­˜å ç”¨
- ç¼“å­˜å¤±æ•ˆéœ€è¦é‡æ–°ç¼–è¯‘

---

## ğŸ“ å¾…åŠäº‹é¡¹

### Phase 3: å·¥å‚ä¸åŸºç±»æ”¹é€  (ä¸‹ä¸€æ­¥)
- [ ] é‡æ„ StrategyFactory
- [ ] å¢å¼º BaseStrategyï¼ˆæ·»åŠ å…ƒä¿¡æ¯ï¼‰
- [ ] åˆ›å»º predefined/ ç›®å½•
- [ ] ç§»åŠ¨ç°æœ‰ç­–ç•¥åˆ° predefined/
- [ ] æ›´æ–°ç­–ç•¥ç³»ç»Ÿ __init__.py

### Phase 4: æ€§èƒ½ä¼˜åŒ–
- [ ] å®ç° Redis ç¼“å­˜æ”¯æŒ
- [ ] æ·»åŠ å¹¶è¡ŒåŠ è½½
- [ ] ä»£ç é¢„ç¼–è¯‘ä¼˜åŒ–
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•

### Phase 5: é›†æˆä¸æ–‡æ¡£
- [ ] ä¸ Backend å¯¹æ¥æ•°æ®åº“è¡¨
- [ ] ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•
- [ ] API ä½¿ç”¨æ–‡æ¡£
- [ ] éƒ¨ç½²æŒ‡å—

---

## ğŸ¯ æˆæœæ€»ç»“

### å®ç°çš„æ ¸å¿ƒåŠŸèƒ½
âœ… åŒæ–¹æ¡ˆæ”¯æŒï¼ˆå‚æ•°é…ç½® + AIä»£ç ç”Ÿæˆï¼‰
âœ… ç»Ÿä¸€åŠ è½½æ¥å£
âœ… å¤šå±‚å®‰å…¨é˜²æŠ¤
âœ… åŠ¨æ€ä»£ç æ²™ç®±æ‰§è¡Œ
âœ… å¤šçº§ç¼“å­˜æœºåˆ¶
âœ… å®Œæ•´çš„å®¡è®¡æ—¥å¿—
âœ… 52ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡

### æŠ€æœ¯äº®ç‚¹
- **å®‰å…¨ç¬¬ä¸€**: Coreå±‚ç‹¬ç«‹çš„å®‰å…¨éªŒè¯ä½“ç³»
- **é›¶ä¿¡ä»»åŸåˆ™**: ä¸ä¿¡ä»»Backendçš„éªŒè¯ç»“æœ
- **å—é™æ²™ç®±**: ä¸¥æ ¼é™åˆ¶åŠ¨æ€ä»£ç æƒé™
- **å®Œæ•´å®¡è®¡**: æ‰€æœ‰æ“ä½œå¯è¿½æº¯
- **é«˜å¯æµ‹è¯•æ€§**: å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•è¦†ç›–

### ç¬¦åˆè®¾è®¡ç›®æ ‡
âœ… ç»Ÿä¸€ç­–ç•¥æ¥å£
âœ… é…ç½®åŠ è½½æœºåˆ¶
âœ… åŠ¨æ€ä»£ç åŠ è½½
âœ… å¤šå±‚å®‰å…¨é˜²æŠ¤
âœ… å‘åå…¼å®¹ï¼ˆæœªç ´åç°æœ‰ä»£ç ï¼‰
âœ… å¯æ‰©å±•æ€§

---

## ğŸ“ è”ç³»ä¸åé¦ˆ

**å®æ–½å›¢é˜Ÿ**: Architecture Team
**å®Œæˆæ—¥æœŸ**: 2026-02-08
**ä¸‹ä¸€æ­¥**: Phase 3 - å·¥å‚ä¸åŸºç±»æ”¹é€ 

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»æ¶æ„å›¢é˜Ÿã€‚

---

**æŠ¥å‘Šç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-02-08
