# Phase 4: 实盘交易系统

**阶段**: Phase 4
**时间**: TBD (预计2026-Q3开始)
**优先级**: 🟢 Medium (长期目标)
**当前进度**: 0%

---

## 目标

构建完整的实盘交易系统，支持自动化交易、实时监控和风险管理。

---

## 任务清单

### 任务组6: 实盘交易接口

#### 任务6.1: 券商接口对接

**状态**: 📋 规划中
**预计工作量**: 3-4周
**优先级**: P0

**目标券商**:
- 东方财富证券
- 华泰证券
- 国金证券
- 其他主流券商

**功能需求**:
- 账户认证与登录
- 持仓查询
- 资金查询
- 委托下单 (限价/市价/条件单)
- 撤单功能
- 成交查询
- 历史委托查询

**技术方案**:
```python
class BrokerInterface(ABC):
    """券商接口抽象基类"""

    @abstractmethod
    def login(self, username: str, password: str) -> Response:
        """登录"""
        pass

    @abstractmethod
    def get_positions(self) -> Response[List[Position]]:
        """查询持仓"""
        pass

    @abstractmethod
    def place_order(self, order: Order) -> Response[str]:
        """下单"""
        pass

    @abstractmethod
    def cancel_order(self, order_id: str) -> Response:
        """撤单"""
        pass
```

---

#### 任务6.2: 订单管理系统

**状态**: 📋 规划中
**预计工作量**: 2-3周
**优先级**: P0

**功能需求**:
- 订单生命周期管理
- 订单状态追踪
- 订单队列管理
- 订单持久化存储
- 订单撤回与修改
- 批量下单支持

**核心模块**:
```python
class OrderManager:
    """订单管理器"""

    def submit_order(self, order: Order) -> str:
        """提交订单"""
        pass

    def cancel_order(self, order_id: str) -> bool:
        """取消订单"""
        pass

    def get_order_status(self, order_id: str) -> OrderStatus:
        """查询订单状态"""
        pass

    def get_pending_orders(self) -> List[Order]:
        """获取待成交订单"""
        pass
```

---

#### 任务6.3: 实盘风控系统

**状态**: 📋 规划中
**预计工作量**: 2-3周
**优先级**: P1

**风控规则**:
1. **资金风控**
   - 最大单笔交易金额
   - 最大日交易金额
   - 最大持仓比例
   - 现金留存比例

2. **仓位风控**
   - 单股最大仓位
   - 行业最大仓位
   - 总仓位限制
   - 杠杆倍数限制

3. **交易频率风控**
   - 单股日内最大交易次数
   - 日内最大交易总次数
   - 冷却期设置

4. **价格风控**
   - 涨跌停限制
   - 价格偏离度检查
   - 滑点控制

**实现示例**:
```python
class RiskController:
    """实盘风控控制器"""

    def check_order(self, order: Order) -> Tuple[bool, str]:
        """检查订单是否符合风控规则"""
        # 资金检查
        if not self._check_capital(order):
            return False, "资金不足或超出限额"

        # 仓位检查
        if not self._check_position(order):
            return False, "超出仓位限制"

        # 交易频率检查
        if not self._check_frequency(order):
            return False, "超出交易频率限制"

        return True, "通过风控检查"
```

---

#### 任务6.4: 实时监控告警

**状态**: 📋 规划中
**预计工作量**: 1-2周
**优先级**: P1

**监控指标**:
- 账户资金变化
- 持仓市值变化
- 订单执行情况
- 系统运行状态
- 网络连接状态
- 异常交易检测

**告警渠道**:
- 邮件通知
- 微信/钉钉通知
- 短信通知 (紧急情况)
- Web Dashboard显示

**告警级别**:
- 🔴 **Critical**: 系统故障、重大亏损
- 🟡 **Warning**: 风控触发、订单失败
- 🟢 **Info**: 正常交易、日常统计

---

#### 任务6.5: 交易日志与审计

**状态**: 📋 规划中
**预计工作量**: 1周
**优先级**: P2

**日志内容**:
- 所有订单记录 (提交/成交/撤销)
- 账户变动记录
- 风控触发记录
- 系统操作记录
- 异常事件记录

**审计功能**:
- 交易复盘
- 策略效果分析
- 风控效果评估
- 合规性检查

---

## 技术架构

### 系统架构图

```
┌─────────────────────────────────────────────────────┐
│                  Trading Dashboard                   │
│              (Web UI / 监控告警)                      │
└─────────────────┬───────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────┐
│                 Order Manager                        │
│         (订单管理 / 状态追踪 / 队列管理)              │
└─────────────────┬───────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────┐
│               Risk Controller                        │
│         (风控检查 / 规则引擎 / 告警触发)              │
└─────────────────┬───────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────┐
│              Broker Interface                        │
│         (券商API / 协议适配 / 连接管理)              │
└─────────────────┬───────────────────────────────────┘
                  │
          ┌───────┴────────┐
┌─────────▼─────┐  ┌───────▼────────┐
│ 东方财富       │  │ 华泰证券        │  ...
│ (券商系统)     │  │ (券商系统)      │
└───────────────┘  └────────────────┘
```

### 数据流

```
策略信号 → 订单生成 → 风控检查 → 券商下单 → 状态跟踪 → 持仓更新
   ↓                    ↓              ↓          ↓
 日志记录            告警通知       日志记录   监控展示
```

---

## 技术选型

| 模块 | 技术方案 | 说明 |
|------|---------|------|
| 券商接口 | easytrader + 自研 | 封装统一接口 |
| 订单管理 | PostgreSQL + Redis | 持久化 + 缓存 |
| 消息队列 | Redis Streams | 订单异步处理 |
| 监控告警 | Prometheus + Grafana | 指标监控 |
| 实时通知 | 企业微信/钉钉 API | 告警推送 |
| Web Dashboard | FastAPI + React | 实时监控界面 |

---

## 风险评估

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| 券商接口变更 | 高 | 高 | 抽象接口层，快速适配 |
| 网络连接中断 | 中 | 高 | 断线重连 + 本地队列 |
| 订单执行失败 | 中 | 中 | 重试机制 + 告警 |
| 风控误判 | 低 | 中 | 规则可配置 + 人工审核 |
| 资金账户安全 | 低 | 极高 | 多因子认证 + 操作日志 |

---

## 合规性要求

1. **监管合规**
   - 遵守证监会相关规定
   - 避免操纵市场行为
   - 禁止内幕交易

2. **风险提示**
   - 明确告知用户交易风险
   - 提供风险承受能力评估
   - 设置风险警示线

3. **数据安全**
   - 账户信息加密存储
   - API密钥安全管理
   - 操作日志完整记录

---

## 成功标准

- ✅ 支持主流券商接口 (3+)
- ✅ 订单成功率 ≥ 99%
- ✅ 风控规则覆盖率 100%
- ✅ 告警响应时间 < 5秒
- ✅ 系统可用性 ≥ 99.9%

---

## 预期收益

1. **自动化交易**: 7x24小时自动化执行
2. **风险控制**: 实时风控，避免重大损失
3. **效率提升**: 策略 → 下单全自动化
4. **数据积累**: 完整的交易数据用于分析优化

---

## 里程碑

| 阶段 | 时间 | 目标 |
|------|------|------|
| 需求调研 | Week 1-2 | 完成技术方案设计 |
| 接口开发 | Week 3-6 | 完成券商接口对接 |
| 功能开发 | Week 7-10 | 完成订单管理和风控 |
| 测试验证 | Week 11-12 | 模拟盘测试 |
| 小额实盘 | Week 13-14 | 小额资金验证 |
| 全面上线 | Week 15+ | 正式运行 |

---

**负责人**: Quant Team
**审查周期**: 双周
**最后更新**: 2026-02-01
