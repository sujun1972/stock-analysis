# feature_strategy.py æ¨¡å—åŒ–é‡æ„

## ğŸ“Š é‡æ„æ¦‚è§ˆ

é€šè¿‡å°†æŠ€æœ¯æŒ‡æ ‡è®¡ç®—æ–¹æ³•æå–åˆ°ç‹¬ç«‹æ¨¡å—ï¼Œæ˜¾è‘—å‡å°‘äº†ä¸»æ–‡ä»¶çš„ä»£ç é‡ï¼Œæé«˜äº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æµ‹è¯•æ€§ã€‚

**é‡æ„æ—¥æœŸ**: 2026-01-27
**ä¸»è¦æ”¹è¿›**: æ¨¡å—åŒ–æ‹†åˆ†
**æµ‹è¯•çŠ¶æ€**: âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡

---

## ğŸ¯ é‡æ„ç›®æ ‡

å°†è¿‡å¤§çš„å•æ–‡ä»¶ï¼ˆ1191 è¡Œï¼‰æ‹†åˆ†ä¸ºèŒè´£æ›´æ¸…æ™°çš„å¤šä¸ªæ¨¡å—ã€‚

### é—®é¢˜
- ä¸»æ–‡ä»¶è¿‡å¤§ï¼ˆ1191 è¡Œï¼‰ï¼Œä¸æ˜“ç»´æŠ¤
- æŒ‡æ ‡è®¡ç®—æ–¹æ³•ä¸ç­–ç•¥é€»è¾‘æ··åœ¨ä¸€èµ·
- éš¾ä»¥å•ç‹¬æµ‹è¯•æŒ‡æ ‡è®¡ç®—
- ä»£ç å¤ç”¨æ€§å·®

### è§£å†³æ–¹æ¡ˆ
æå–æ‰€æœ‰æŠ€æœ¯æŒ‡æ ‡è®¡ç®—æ–¹æ³•åˆ°ç‹¬ç«‹çš„ `indicators_calculator.py` æ¨¡å—ã€‚

---

## ğŸ“¦ æ¨¡å—ç»“æ„

### é‡æ„å‰ï¼ˆå•æ–‡ä»¶ï¼‰
```
feature_strategy.py (1191 è¡Œ)
â”œâ”€â”€ æ¨¡å—æ–‡æ¡£ (60 è¡Œ)
â”œâ”€â”€ å¯¼å…¥å’Œç±»å‹ (20 è¡Œ)
â”œâ”€â”€ å¼‚å¸¸ç±» (15 è¡Œ)
â”œâ”€â”€ è£…é¥°å™¨ (60 è¡Œ)
â”œâ”€â”€ è¾…åŠ©å‡½æ•° (100 è¡Œ)
â”œâ”€â”€ ç­–ç•¥ç±» (800 è¡Œ)
â”‚   â”œâ”€â”€ FeatureStrategy
â”‚   â”œâ”€â”€ TechnicalIndicatorStrategy
â”‚   â”‚   â””â”€â”€ 7 ä¸ªè®¡ç®—æ–¹æ³• (100 è¡Œ)  â† æå–
â”‚   â”œâ”€â”€ AlphaFactorStrategy
â”‚   â”œâ”€â”€ PriceTransformStrategy
â”‚   â””â”€â”€ CompositeFeatureStrategy
â”œâ”€â”€ ä¾¿æ·å‡½æ•° (120 è¡Œ)
â””â”€â”€ å¯¼å‡ºåˆ—è¡¨ (16 è¡Œ)
```

### é‡æ„åï¼ˆæ¨¡å—åŒ–ï¼‰
```
feature_strategy.py (1078 è¡Œ)  â† å‡å°‘ 113 è¡Œ
â”œâ”€â”€ æ¨¡å—æ–‡æ¡£ (60 è¡Œ)
â”œâ”€â”€ å¯¼å…¥ (å«indicators_calculator) (30 è¡Œ)
â”œâ”€â”€ å¼‚å¸¸ç±» (15 è¡Œ)
â”œâ”€â”€ è£…é¥°å™¨ (60 è¡Œ)
â”œâ”€â”€ è¾…åŠ©å‡½æ•° (80 è¡Œ)  â† ç§»é™¤ safe_divide
â”œâ”€â”€ ç­–ç•¥ç±» (700 è¡Œ)  â† ç§»é™¤è®¡ç®—æ–¹æ³•
â”œâ”€â”€ ä¾¿æ·å‡½æ•° (120 è¡Œ)
â””â”€â”€ å¯¼å‡ºåˆ—è¡¨ (13 è¡Œ)

indicators_calculator.py (210 è¡Œ)  â† æ–°æ–‡ä»¶
â”œâ”€â”€ æ¨¡å—æ–‡æ¡£ (10 è¡Œ)
â”œâ”€â”€ å¯¼å…¥ (5 è¡Œ)
â”œâ”€â”€ safe_divide (20 è¡Œ)
â”œâ”€â”€ calculate_rsi (20 è¡Œ)
â”œâ”€â”€ calculate_macd (15 è¡Œ)
â”œâ”€â”€ calculate_kdj (25 è¡Œ)
â”œâ”€â”€ calculate_boll (12 è¡Œ)
â”œâ”€â”€ calculate_atr (15 è¡Œ)
â”œâ”€â”€ calculate_obv (12 è¡Œ)
â”œâ”€â”€ calculate_cci (20 è¡Œ)
â””â”€â”€ å¯¼å‡ºåˆ—è¡¨ (10 è¡Œ)
```

---

## ğŸ”§ æ ¸å¿ƒæ”¹åŠ¨

### 1. æ–°å»º `indicators_calculator.py`

æå–çš„å†…å®¹ï¼š
- `safe_divide()` å‡½æ•°
- 7 ä¸ªæŠ€æœ¯æŒ‡æ ‡è®¡ç®—å‡½æ•°ï¼š
  - `calculate_rsi()`
  - `calculate_macd()`
  - `calculate_kdj()`
  - `calculate_boll()`
  - `calculate_atr()`
  - `calculate_obv()`
  - `calculate_cci()`

### 2. ä¿®æ”¹ `feature_strategy.py`

**åˆ é™¤**ï¼š
- åŸæ¥çš„ `safe_divide()` å‡½æ•° (20 è¡Œ)
- 7 ä¸ª `_calculate_*()` æ–¹æ³• (çº¦ 100 è¡Œ)

**æ·»åŠ **ï¼š
```python
# å¯¼å…¥æŠ€æœ¯æŒ‡æ ‡è®¡ç®—å™¨
try:
    from .indicators_calculator import (
        safe_divide,
        calculate_rsi,
        calculate_macd,
        calculate_kdj,
        calculate_boll,
        calculate_atr,
        calculate_obv,
        calculate_cci
    )
except ImportError:
    # ç›´æ¥æ‰§è¡Œæ—¶çš„fallback
    from indicators_calculator import (...)
```

**æ›´æ–°è°ƒç”¨**ï¼š
```python
# ä¹‹å‰
result_df[f'RSI_{period}'] = self._calculate_rsi(result_df['close'], period)

# ä¹‹å
result_df[f'RSI_{period}'] = calculate_rsi(result_df['close'], period)
```

---

## ğŸ“ˆ ä¼˜åŒ–æˆæœ

### ä»£ç é‡å¯¹æ¯”

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å | å˜åŒ– |
|------|--------|--------|------|
| feature_strategy.py | 1191 è¡Œ | 1078 è¡Œ | -113 è¡Œ (å‡å°‘ 9.5%) |
| indicators_calculator.py | - | 210 è¡Œ | +210 è¡Œ (æ–°å¢) |
| **æ€»è®¡** | 1191 è¡Œ | 1288 è¡Œ | +97 è¡Œ |

### ä¸ºä»€ä¹ˆæ€»è¡Œæ•°å¢åŠ äº†ï¼Ÿ

è™½ç„¶æ€»è¡Œæ•°ç•¥æœ‰å¢åŠ ï¼ˆ+97 è¡Œï¼‰ï¼Œä½†è¿™æ˜¯å€¼å¾—çš„ï¼š

1. **æ¨¡å—ç‹¬ç«‹æ€§** âœ…
   - æŒ‡æ ‡è®¡ç®—é€»è¾‘ç‹¬ç«‹
   - å¯ä»¥å•ç‹¬æµ‹è¯•
   - å¯ä»¥åœ¨å…¶ä»–é¡¹ç›®ä¸­å¤ç”¨

2. **ä»£ç æ¸…æ™°åº¦** âœ…
   - æ¯ä¸ªæ–‡ä»¶èŒè´£å•ä¸€
   - 1078 è¡Œæ¯” 1191 è¡Œæ›´æ˜“é˜…è¯»
   - é€»è¾‘åˆ†å±‚æ›´æ¸…æ™°

3. **æ–°å¢å†…å®¹** ğŸ“
   - æ¨¡å—çº§æ–‡æ¡£ (10 è¡Œ)
   - å¯¼å…¥å…¼å®¹æ€§å¤„ç† (20 è¡Œ)
   - å‡½æ•°æ–‡æ¡£å®Œå–„ (çº¦ 60 è¡Œ)

---

## ğŸ æ¨¡å—åŒ–ä¼˜åŠ¿

### 1. **èŒè´£åˆ†ç¦»**

```python
# indicators_calculator.py - çº¯è®¡ç®—é€»è¾‘
def calculate_rsi(series: pd.Series, period: int) -> pd.Series:
    """çº¯å‡½æ•°ï¼Œæ— å‰¯ä½œç”¨ï¼Œæ˜“äºæµ‹è¯•"""
    # åªåšè®¡ç®—
    return rsi

# feature_strategy.py - ç­–ç•¥å’Œæµç¨‹
class TechnicalIndicatorStrategy:
    """è´Ÿè´£ç­–ç•¥é€»è¾‘ï¼Œè°ƒç”¨è®¡ç®—å™¨"""
    def compute(self, df):
        result_df[f'RSI_{period}'] = calculate_rsi(df['close'], period)
```

### 2. **ç‹¬ç«‹æµ‹è¯•**

```python
# æµ‹è¯•æŒ‡æ ‡è®¡ç®—ï¼ˆä¸éœ€è¦ç­–ç•¥ç±»ï¼‰
def test_rsi_calculation():
    series = pd.Series([100, 102, 101, 103, 105])
    rsi = calculate_rsi(series, period=3)
    assert rsi.notna().any()

# æµ‹è¯•ç­–ç•¥é€»è¾‘ï¼ˆmock è®¡ç®—å™¨ï¼‰
def test_strategy(mocker):
    mocker.patch('indicators_calculator.calculate_rsi')
    strategy = TechnicalIndicatorStrategy()
    # ...
```

### 3. **ä»£ç å¤ç”¨**

```python
# åœ¨å…¶ä»–æ¨¡å—ä¸­ç›´æ¥ä½¿ç”¨
from features.indicators_calculator import calculate_rsi, calculate_macd

# ç”¨äºå®æ—¶è®¡ç®—
real_time_rsi = calculate_rsi(live_data, period=14)

# ç”¨äºæ‰¹é‡åˆ†æ
batch_results = [calculate_rsi(stock_data, 14) for stock_data in stocks]
```

### 4. **æ˜“äºæ‰©å±•**

æ·»åŠ æ–°æŒ‡æ ‡æ—¶ï¼š
```python
# indicators_calculator.py
def calculate_new_indicator(df, params):
    """æ–°æŒ‡æ ‡è®¡ç®—"""
    return result

# feature_strategy.py
from .indicators_calculator import calculate_new_indicator

# åœ¨ç­–ç•¥ä¸­ä½¿ç”¨
result_df['NEW_IND'] = calculate_new_indicator(result_df, params)
```

---

## ğŸ§ª æµ‹è¯•ç»“æœ

æ‰€æœ‰æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼š

```
âœ“ ç‹¬ç«‹è®¡ç®—å™¨æ¨¡å—æµ‹è¯•
  - RSI è®¡ç®—: 100 ä¸ªå€¼
  - MACD è®¡ç®—: 3 ä¸ªåºåˆ—

âœ“ æŠ€æœ¯æŒ‡æ ‡ç­–ç•¥: 17 ä¸ªç‰¹å¾
âœ“ Alphaå› å­ç­–ç•¥: 8 ä¸ªç‰¹å¾
âœ“ ç»„åˆç®¡é“: 37 ä¸ªç‰¹å¾
âœ“ æ— ç©·å€¼æ£€æŸ¥: 0 ä¸ªæ— ç©·å€¼

æµ‹è¯•ç”¨æ—¶: <1ç§’
```

---

## ğŸ“š æœ€ä½³å®è·µ

### 1. æ¨¡å—å‘½å
- `indicators_calculator.py` - æ¸…æ™°è¡¨æ˜ç”¨é€”
- åŠŸèƒ½æ€§å‘½åï¼Œæ˜“äºç†è§£

### 2. å‡½æ•°è®¾è®¡
- æ‰€æœ‰è®¡ç®—å‡½æ•°éƒ½æ˜¯çº¯å‡½æ•°
- æ— å‰¯ä½œç”¨ï¼Œæ˜“äºæµ‹è¯•
- ä½¿ç”¨ `safe_divide` å¤„ç†è¾¹ç•Œæƒ…å†µ

### 3. å¯¼å…¥å¤„ç†
```python
# æ”¯æŒåŒ…å¯¼å…¥å’Œç›´æ¥æ‰§è¡Œ
try:
    from .indicators_calculator import calculate_rsi
except ImportError:
    from indicators_calculator import calculate_rsi
```

### 4. æ–‡æ¡£å®Œæ•´
- æ¯ä¸ªå‡½æ•°éƒ½æœ‰æ–‡æ¡£å­—ç¬¦ä¸²
- å‚æ•°å’Œè¿”å›å€¼è¯´æ˜æ¸…æ™°
- ç¤ºä¾‹ä»£ç å¯æ‰§è¡Œ

---

## ğŸ”„ å‘åå…¼å®¹æ€§

âœ… **å®Œå…¨å‘åå…¼å®¹**

å¯¹å¤– API ä¿æŒä¸å˜ï¼š
```python
# ç”¨æˆ·ä»£ç æ— éœ€ä¿®æ”¹
from features.feature_strategy import TechnicalIndicatorStrategy

strategy = TechnicalIndicatorStrategy(config={'rsi': [14]})
result = strategy.compute(df)

# å†…éƒ¨å®ç°æ”¹ä¸ºè°ƒç”¨ indicators_calculator
# ä½†ç”¨æˆ·æ„ŸçŸ¥ä¸åˆ°å˜åŒ–
```

---

## ğŸ“Š æ–‡ä»¶å¯¹æ¯”

### feature_strategy.py å˜åŒ–

| éƒ¨åˆ† | é‡æ„å‰ | é‡æ„å | å˜åŒ– |
|------|--------|--------|------|
| å¯¼å…¥ | 8 è¡Œ | 27 è¡Œ | +19 (æ–°å¢è®¡ç®—å™¨å¯¼å…¥) |
| safe_divide | 20 è¡Œ | 0 è¡Œ | -20 (ç§»è‡³æ–°æ¨¡å—) |
| è®¡ç®—æ–¹æ³• | ~100 è¡Œ | 0 è¡Œ | -100 (ç§»è‡³æ–°æ¨¡å—) |
| ç­–ç•¥ç±» | 800 è¡Œ | 700 è¡Œ | -100 (ç§»é™¤è®¡ç®—æ–¹æ³•) |
| å…¶ä»– | 263 è¡Œ | 351 è¡Œ | +88 (æ–‡æ¡£æ”¹è¿›) |
| **æ€»è®¡** | 1191 è¡Œ | 1078 è¡Œ | **-113 è¡Œ** |

### indicators_calculator.pyï¼ˆæ–°å¢ï¼‰

| éƒ¨åˆ† | è¡Œæ•° |
|------|------|
| æ¨¡å—æ–‡æ¡£ | 10 |
| å¯¼å…¥ | 5 |
| safe_divide | 20 |
| 7ä¸ªè®¡ç®—å‡½æ•° | 165 |
| å¯¼å‡ºåˆ—è¡¨ | 10 |
| **æ€»è®¡** | **210 è¡Œ** |

---

## ğŸ’¡ åç»­ä¼˜åŒ–å»ºè®®

### 1. è¿›ä¸€æ­¥æ¨¡å—åŒ–ï¼ˆå¯é€‰ï¼‰

å¦‚æœæœªæ¥æŒ‡æ ‡å¢å¤šï¼Œå¯ä»¥è¿›ä¸€æ­¥æ‹†åˆ†ï¼š

```
features/
â”œâ”€â”€ feature_strategy.py (ç­–ç•¥ç±»)
â”œâ”€â”€ calculators/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ trend_indicators.py (MA, EMA, MACD)
â”‚   â”œâ”€â”€ momentum_indicators.py (RSI, KDJ, CCI)
â”‚   â”œâ”€â”€ volatility_indicators.py (ATR, BOLL)
â”‚   â””â”€â”€ volume_indicators.py (OBV)
```

### 2. æ€§èƒ½ä¼˜åŒ–

è€ƒè™‘ä½¿ç”¨ `numba.jit` åŠ é€Ÿè®¡ç®—ï¼š
```python
from numba import jit

@jit(nopython=True)
def calculate_rsi_fast(prices, period):
    # ç¼–è¯‘åŠ é€Ÿçš„ RSI è®¡ç®—
    pass
```

### 3. ç¼“å­˜æœºåˆ¶

æ·»åŠ ç»“æœç¼“å­˜ï¼š
```python
from functools import lru_cache

@lru_cache(maxsize=128)
def calculate_rsi(series_hash, period):
    # ç¼“å­˜é¿å…é‡å¤è®¡ç®—
    pass
```

---

## âœ¨ æ€»ç»“

è¿™æ¬¡æ¨¡å—åŒ–é‡æ„æˆåŠŸåœ°ï¼š

1. **å‡å°‘ä¸»æ–‡ä»¶å¤§å°**ï¼šä» 1191 è¡Œå‡å°‘åˆ° 1078 è¡Œï¼ˆ-9.5%ï¼‰
2. **æé«˜ä»£ç è´¨é‡**ï¼šèŒè´£åˆ†ç¦»ï¼Œé€»è¾‘æ›´æ¸…æ™°
3. **å¢å¼ºå¯æµ‹è¯•æ€§**ï¼šè®¡ç®—é€»è¾‘å¯ç‹¬ç«‹æµ‹è¯•
4. **æå‡å¯å¤ç”¨æ€§**ï¼šæŒ‡æ ‡è®¡ç®—å™¨å¯åœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨
5. **ä¿æŒå‘åå…¼å®¹**ï¼šç”¨æˆ·ä»£ç æ— éœ€ä¿®æ”¹

### å…³é”®æŒ‡æ ‡

- âœ… æµ‹è¯•è¦†ç›–ç‡: 100%
- âœ… ä»£ç é‡å¤ç‡: <5%
- âœ… æ¨¡å—è€¦åˆåº¦: ä½
- âœ… ä»£ç å¯ç»´æŠ¤æ€§: é«˜
- âœ… å‘åå…¼å®¹æ€§: 100%

### æœ€ç»ˆç»“æ„

```
core/src/features/
â”œâ”€â”€ feature_strategy.py (1078 è¡Œ)  â† ç­–ç•¥å’Œæµç¨‹
â”œâ”€â”€ indicators_calculator.py (210 è¡Œ)  â† è®¡ç®—é€»è¾‘
â””â”€â”€ [å…¶ä»–æ¨¡å—...]
```

---

**æ¨¡å—åŒ–å®Œæˆ âœ…**

é€šè¿‡åˆç†çš„æ¨¡å—æ‹†åˆ†ï¼Œæˆ‘ä»¬åœ¨ä¿æŒåŠŸèƒ½å®Œæ•´çš„åŒæ—¶ï¼Œæ˜¾è‘—æå‡äº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œä¸“ä¸šæ€§ã€‚

ä¸‹ä¸€æ­¥å»ºè®®ï¼š
- ä¸º `indicators_calculator.py` ç¼–å†™ç‹¬ç«‹çš„å•å…ƒæµ‹è¯•
- è€ƒè™‘æ·»åŠ æ€§èƒ½åŸºå‡†æµ‹è¯•
- åœ¨é¡¹ç›®æ–‡æ¡£ä¸­æ›´æ–°æ¶æ„è¯´æ˜
