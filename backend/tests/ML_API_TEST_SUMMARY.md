# ML Training API æµ‹è¯•æ‘˜è¦

**åˆ›å»ºæ—¥æœŸ**: 2026-02-03
**ä»»åŠ¡**: ä»»åŠ¡ 1.1 - ML Training API æµ‹è¯•è¡¥å…… (P1)
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ¬¡ä»»åŠ¡å®Œæˆäº† ML Training API çš„å®Œæ•´æµ‹è¯•è¦†ç›–ï¼ŒåŒ…æ‹¬ï¼š
- MLTrainingService å•å…ƒæµ‹è¯•
- TrainingTaskManager å•å…ƒæµ‹è¯•
- ML API ç«¯ç‚¹é›†æˆæµ‹è¯•

---

## ğŸ“ æµ‹è¯•æ–‡ä»¶

### 1. MLTrainingService å•å…ƒæµ‹è¯•
**æ–‡ä»¶**: `tests/unit/services/test_ml_training_service.py`
**è¡Œæ•°**: 400+ è¡Œ
**æµ‹è¯•ç±»æ•°**: 10 ä¸ª
**æµ‹è¯•ç”¨ä¾‹æ•°**: 26 ä¸ª

#### æµ‹è¯•è¦†ç›–èŒƒå›´ï¼š
- âœ… `__init__` - åˆå§‹åŒ–ï¼ˆ2 ä¸ªæµ‹è¯•ï¼‰
- âœ… `create_task` - åˆ›å»ºä»»åŠ¡ï¼ˆ2 ä¸ªæµ‹è¯•ï¼‰
- âœ… `run_training/start_training` - æ‰§è¡Œè®­ç»ƒï¼ˆ3 ä¸ªæµ‹è¯•ï¼‰
- âœ… `get_task` - è·å–ä»»åŠ¡ä¿¡æ¯ï¼ˆ2 ä¸ªæµ‹è¯•ï¼‰
- âœ… `list_tasks` - åˆ—å‡ºä»»åŠ¡ï¼ˆ3 ä¸ªæµ‹è¯•ï¼‰
- âœ… `cancel_task` - å–æ¶ˆä»»åŠ¡ï¼ˆ2 ä¸ªæµ‹è¯•ï¼‰
- âœ… `delete_task` - åˆ é™¤ä»»åŠ¡ï¼ˆ2 ä¸ªæµ‹è¯•ï¼‰
- âœ… `predict` - æ¨¡å‹é¢„æµ‹ï¼ˆ2 ä¸ªæµ‹è¯•ï¼‰
- âœ… `batch_predict` - æ‰¹é‡é¢„æµ‹ï¼ˆ1 ä¸ªæµ‹è¯•ï¼‰
- âœ… `predict_from_experiment` - ä»å®éªŒé¢„æµ‹ï¼ˆ1 ä¸ªæµ‹è¯•ï¼‰

#### å…³é”®æµ‹è¯•åœºæ™¯ï¼š
- âœ… å•è‚¡ç¥¨è®­ç»ƒä»»åŠ¡åˆ›å»º
- âœ… æ± åŒ–è®­ç»ƒä»»åŠ¡åˆ›å»ºï¼ˆå¤šè‚¡ç¥¨ï¼‰
- âœ… ä»»åŠ¡çŠ¶æ€ç®¡ç†ï¼ˆpending/running/completed/failedï¼‰
- âœ… ä»»åŠ¡ä¸å­˜åœ¨å¼‚å¸¸å¤„ç†
- âœ… ä»»åŠ¡çŠ¶æ€è¿‡æ»¤å’Œåˆ†é¡µ
- âœ… ä½¿ç”¨ model_id å’Œ experiment_id è¿›è¡Œé¢„æµ‹
- âœ… æ‰¹é‡é¢„æµ‹å¤šåªè‚¡ç¥¨

---

### 2. TrainingTaskManager å•å…ƒæµ‹è¯•
**æ–‡ä»¶**: `tests/unit/services/test_training_task_manager.py`
**è¡Œæ•°**: 550+ è¡Œ
**æµ‹è¯•ç±»æ•°**: 11 ä¸ª
**æµ‹è¯•ç”¨ä¾‹æ•°**: 29 ä¸ª

#### æµ‹è¯•è¦†ç›–èŒƒå›´ï¼š
- âœ… `__init__` - åˆå§‹åŒ–å’Œå…ƒæ•°æ®åŠ è½½ï¼ˆ3 ä¸ªæµ‹è¯•ï¼‰
- âœ… `create_task` - åˆ›å»ºä»»åŠ¡ï¼ˆ2 ä¸ªæµ‹è¯•ï¼‰
- âœ… `run_training` - æ‰§è¡Œè®­ç»ƒï¼ˆ3 ä¸ªæµ‹è¯•ï¼‰
- âœ… `_run_single_stock_training` - å•è‚¡ç¥¨è®­ç»ƒï¼ˆ1 ä¸ªæµ‹è¯•ï¼‰
- âœ… `_run_pooled_training` - æ± åŒ–è®­ç»ƒï¼ˆ1 ä¸ªæµ‹è¯•ï¼‰
- âœ… `get_task` - è·å–ä»»åŠ¡ï¼ˆ2 ä¸ªæµ‹è¯•ï¼‰
- âœ… `list_tasks` - åˆ—å‡ºä»»åŠ¡ï¼ˆ3 ä¸ªæµ‹è¯•ï¼‰
- âœ… `cancel_task` - å–æ¶ˆä»»åŠ¡ï¼ˆ3 ä¸ªæµ‹è¯•ï¼‰
- âœ… `delete_task` - åˆ é™¤ä»»åŠ¡ï¼ˆ2 ä¸ªæµ‹è¯•ï¼‰
- âœ… `_save_metadata/_load_metadata` - å…ƒæ•°æ®ç®¡ç†ï¼ˆ1 ä¸ªæµ‹è¯•ï¼‰

#### å…³é”®æµ‹è¯•åœºæ™¯ï¼š
- âœ… ä»»åŠ¡å…ƒæ•°æ®æŒä¹…åŒ–åŠ è½½
- âœ… å”¯ä¸€ä»»åŠ¡ ID ç”Ÿæˆ
- âœ… å•è‚¡ç¥¨è®­ç»ƒæµç¨‹ï¼ˆè°ƒç”¨ CoreTrainingServiceï¼‰
- âœ… æ± åŒ–è®­ç»ƒæµç¨‹ï¼ˆè°ƒç”¨ PooledTrainingPipelineï¼‰
- âœ… Ridge åŸºå‡†å¯¹æ¯”è®­ç»ƒ
- âœ… è®­ç»ƒæˆåŠŸå’Œå¤±è´¥çš„çŠ¶æ€æ›´æ–°
- âœ… ä»»åŠ¡å–æ¶ˆçŠ¶æ€éªŒè¯
- âœ… ä»»åŠ¡åˆ é™¤å’Œå…ƒæ•°æ®æ¸…ç†

---

### 3. ML API é›†æˆæµ‹è¯•
**æ–‡ä»¶**: `tests/integration/api/test_ml_api_integration.py`
**è¡Œæ•°**: 550+ è¡Œ
**æµ‹è¯•ç±»æ•°**: 8 ä¸ª
**æµ‹è¯•ç”¨ä¾‹æ•°**: 19 ä¸ª

#### æµ‹è¯•è¦†ç›–èŒƒå›´ï¼š
- âœ… `POST /api/ml/train` - åˆ›å»ºè®­ç»ƒä»»åŠ¡ï¼ˆ3 ä¸ªæµ‹è¯•ï¼‰
- âœ… `GET /api/ml/tasks/{task_id}` - è·å–ä»»åŠ¡çŠ¶æ€ï¼ˆ2 ä¸ªæµ‹è¯•ï¼‰
- âœ… `GET /api/ml/tasks` - åˆ—å‡ºä»»åŠ¡ï¼ˆ2 ä¸ªæµ‹è¯•ï¼‰
- âœ… `DELETE /api/ml/tasks/{task_id}` - åˆ é™¤ä»»åŠ¡ï¼ˆ2 ä¸ªæµ‹è¯•ï¼‰
- âœ… `POST /api/ml/predict` - æ¨¡å‹é¢„æµ‹ï¼ˆ3 ä¸ªæµ‹è¯•ï¼‰
- âœ… `GET /api/ml/models` - åˆ—å‡ºæ¨¡å‹ï¼ˆ2 ä¸ªæµ‹è¯•ï¼‰
- âœ… `GET /api/ml/features/available` - è·å–å¯ç”¨ç‰¹å¾ï¼ˆ1 ä¸ªæµ‹è¯•ï¼‰
- âœ… `GET /api/ml/features/snapshot` - è·å–ç‰¹å¾å¿«ç…§ï¼ˆ3 ä¸ªæµ‹è¯•ï¼‰
- âœ… `GET /api/ml/tasks/{task_id}/stream` - æµå¼æ¨é€è¿›åº¦ï¼ˆ2 ä¸ªæµ‹è¯•ï¼‰

#### å…³é”®æµ‹è¯•åœºæ™¯ï¼š
- âœ… å•è‚¡ç¥¨è®­ç»ƒä»»åŠ¡åˆ›å»º
- âœ… æ± åŒ–è®­ç»ƒä»»åŠ¡åˆ›å»ºï¼ˆå¤šè‚¡ç¥¨ + RidgeåŸºå‡†ï¼‰
- âœ… ä»»åŠ¡åˆ›å»ºæ—¶çš„åå°ä»»åŠ¡è°ƒåº¦
- âœ… ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢ï¼ˆcompleted/running/pendingï¼‰
- âœ… ä»»åŠ¡åˆ—è¡¨åˆ†é¡µå’ŒçŠ¶æ€è¿‡æ»¤
- âœ… ä½¿ç”¨ experiment_id å’Œ model_id è¿›è¡Œé¢„æµ‹
- âœ… æ¨¡å‹åˆ—è¡¨æŸ¥è¯¢ï¼ˆå¸¦è¿‡æ»¤å’Œåˆ†é¡µï¼‰
- âœ… æŠ€æœ¯æŒ‡æ ‡å’Œ Alpha å› å­åˆ—è¡¨è·å–
- âœ… ç‰¹å¾å¿«ç…§è·å–ï¼ˆä»è®­ç»ƒæ•°æ®ï¼‰
- âœ… SSE æµå¼è¿›åº¦æ¨é€ï¼ˆStreamingResponseï¼‰
- âœ… é”™è¯¯å¤„ç†ï¼ˆ404/400/500ï¼‰

---

## ğŸ“Š æµ‹è¯•ç»Ÿè®¡

| ç±»åˆ« | æ–‡ä»¶æ•° | æµ‹è¯•ç±»æ•° | æµ‹è¯•ç”¨ä¾‹æ•° | ä»£ç è¡Œæ•° |
|-----|-------|---------|----------|---------|
| **å•å…ƒæµ‹è¯• - MLTrainingService** | 1 | 10 | 26 | ~400 |
| **å•å…ƒæµ‹è¯• - TrainingTaskManager** | 1 | 11 | 29 | ~550 |
| **é›†æˆæµ‹è¯• - ML API** | 1 | 8 | 19 | ~550 |
| **æ€»è®¡** | **3** | **29** | **74** | **~1,500** |

---

## ğŸ¯ è¦†ç›–çš„ ML API ç«¯ç‚¹

| ç«¯ç‚¹ | HTTPæ–¹æ³• | åŠŸèƒ½ | æµ‹è¯•æ•°é‡ |
|-----|---------|------|---------|
| `/api/ml/train` | POST | åˆ›å»ºè®­ç»ƒä»»åŠ¡ | 3 |
| `/api/ml/tasks/{task_id}` | GET | è·å–ä»»åŠ¡çŠ¶æ€ | 2 |
| `/api/ml/tasks` | GET | åˆ—å‡ºè®­ç»ƒä»»åŠ¡ | 2 |
| `/api/ml/tasks/{task_id}` | DELETE | åˆ é™¤ä»»åŠ¡ | 2 |
| `/api/ml/tasks/{task_id}/stream` | GET | æµå¼æ¨é€è®­ç»ƒè¿›åº¦ | 2 |
| `/api/ml/predict` | POST | æ¨¡å‹é¢„æµ‹ | 3 |
| `/api/ml/models` | GET | åˆ—å‡ºå¯ç”¨æ¨¡å‹ | 2 |
| `/api/ml/features/available` | GET | è·å–å¯ç”¨ç‰¹å¾åˆ—è¡¨ | 1 |
| `/api/ml/features/snapshot` | GET | è·å–ç‰¹å¾å¿«ç…§ | 3 |
| **æ€»è®¡** | - | **9 ä¸ªç«¯ç‚¹** | **20** |

---

## âœ… æµ‹è¯•ç‰¹ç‚¹

### 1. å®Œæ•´çš„æµ‹è¯•è¦†ç›–
- âœ… è¦†ç›–äº†æ‰€æœ‰ 9 ä¸ª ML API ç«¯ç‚¹
- âœ… è¦†ç›–äº† MLTrainingService çš„æ‰€æœ‰å…¬å¼€æ–¹æ³•
- âœ… è¦†ç›–äº† TrainingTaskManager çš„æ ¸å¿ƒåŠŸèƒ½
- âœ… åŒ…å«æ­£å¸¸æµç¨‹å’Œå¼‚å¸¸æµç¨‹æµ‹è¯•

### 2. Mock ç­–ç•¥
- âœ… ä½¿ç”¨ `unittest.mock` è¿›è¡Œéš”ç¦»æµ‹è¯•
- âœ… Mock äº† CoreTrainingServiceï¼ˆCore é¡¹ç›®è°ƒç”¨ï¼‰
- âœ… Mock äº† PooledTrainingPipelineï¼ˆæ± åŒ–è®­ç»ƒï¼‰
- âœ… Mock äº†æ•°æ®åº“æŸ¥è¯¢ï¼ˆé¿å…ä¾èµ–çœŸå®æ•°æ®åº“ï¼‰
- âœ… Mock äº†æ–‡ä»¶ I/Oï¼ˆå…ƒæ•°æ®ã€æ¨¡å‹æ–‡ä»¶ï¼‰

### 3. æµ‹è¯•ç»“æ„
- âœ… ä½¿ç”¨ AAA æ¨¡å¼ï¼ˆArrange-Act-Assertï¼‰
- âœ… æ¸…æ™°çš„æµ‹è¯•ç±»å’Œæ–¹æ³•å‘½å
- âœ… è¯¦ç»†çš„æµ‹è¯•æ–‡æ¡£å­—ç¬¦ä¸²
- âœ… ä½¿ç”¨ pytest æ ‡è®°ï¼ˆ`@pytest.mark.asyncio`ï¼‰

### 4. å¼‚å¸¸å¤„ç†æµ‹è¯•
- âœ… ä»»åŠ¡ä¸å­˜åœ¨ï¼ˆ404ï¼‰
- âœ… å‚æ•°ç¼ºå¤±ï¼ˆ400ï¼‰
- âœ… æœåŠ¡å¼‚å¸¸ï¼ˆ500ï¼‰
- âœ… ä»»åŠ¡çŠ¶æ€éªŒè¯ï¼ˆcancel/deleteï¼‰
- âœ… æ–‡ä»¶ä¸å­˜åœ¨ï¼ˆæ¨¡å‹æ–‡ä»¶ã€ç‰¹å¾æ–‡ä»¶ï¼‰

---

## ğŸ§ª å¦‚ä½•è¿è¡Œæµ‹è¯•

### è¿è¡Œæ‰€æœ‰ ML ç›¸å…³æµ‹è¯•
```bash
# åœ¨ backend ç›®å½•ä¸‹
cd /Volumes/MacDriver/stock-analysis/backend

# è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•
pytest tests/unit/services/test_ml_training_service.py -v
pytest tests/unit/services/test_training_task_manager.py -v

# è¿è¡Œé›†æˆæµ‹è¯•
pytest tests/integration/api/test_ml_api_integration.py -v

# è¿è¡Œæ‰€æœ‰ ML æµ‹è¯•
pytest tests/ -k "ml" -v

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pytest tests/unit/services/test_ml_training_service.py --cov=app.services.ml_training_service --cov-report=html
pytest tests/unit/services/test_training_task_manager.py --cov=app.services.training_task_manager --cov-report=html
```

### è¿è¡Œç‰¹å®šæµ‹è¯•ç±»
```bash
# è¿è¡Œç‰¹å®šæµ‹è¯•ç±»
pytest tests/unit/services/test_ml_training_service.py::TestCreateTask -v

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–¹æ³•
pytest tests/unit/services/test_ml_training_service.py::TestCreateTask::test_create_task_success -v
```

---

## ğŸ“ æµ‹è¯•æ–‡æ¡£è´¨é‡

### æ¯ä¸ªæµ‹è¯•æ–‡ä»¶åŒ…å«ï¼š
- âœ… æ–‡ä»¶é¡¶éƒ¨çš„è¯¦ç»†æè¿°
- âœ… æµ‹è¯•çš„ç«¯ç‚¹/æ–¹æ³•åˆ—è¡¨
- âœ… ä½œè€…ã€æ—¥æœŸã€ç‰ˆæœ¬ä¿¡æ¯
- âœ… æ¯ä¸ªæµ‹è¯•ç±»çš„æ–‡æ¡£å­—ç¬¦ä¸²
- âœ… æ¯ä¸ªæµ‹è¯•æ–¹æ³•çš„æ–‡æ¡£å­—ç¬¦ä¸²
- âœ… æ¸…æ™°çš„ Arrange-Act-Assert æ³¨é‡Š

### ç¤ºä¾‹ï¼š
```python
"""
MLTrainingService å•å…ƒæµ‹è¯•

æµ‹è¯• ml_training_service.py ä¸­çš„æ‰€æœ‰æ–¹æ³•ï¼š
- create_task
- run_training / start_training
- get_task
- list_tasks
...

ä½œè€…: Backend Team
åˆ›å»ºæ—¥æœŸ: 2026-02-03
ç‰ˆæœ¬: 1.0.0
"""

class TestCreateTask:
    """æµ‹è¯•åˆ›å»ºè®­ç»ƒä»»åŠ¡"""

    @pytest.mark.asyncio
    async def test_create_task_success(self):
        """æµ‹è¯•æˆåŠŸåˆ›å»ºä»»åŠ¡"""
        # Arrange: å‡†å¤‡æµ‹è¯•æ•°æ®
        ...

        # Act: æ‰§è¡Œæµ‹è¯•
        ...

        # Assert: éªŒè¯ç»“æœ
        ...
```

---

## ğŸ”§ ä¾èµ–å’Œé…ç½®

### æµ‹è¯•ä¾èµ–
- `pytest` - æµ‹è¯•æ¡†æ¶
- `pytest-asyncio` - å¼‚æ­¥æµ‹è¯•æ”¯æŒ
- `pytest-cov` - è¦†ç›–ç‡æŠ¥å‘Š
- `unittest.mock` - Mock æ¡†æ¶ï¼ˆPython æ ‡å‡†åº“ï¼‰

### é…ç½®æ–‡ä»¶
- `pytest.ini` - Pytest é…ç½®
- `tests/conftest.py` - å…¨å±€æµ‹è¯•å¤¹å…·

---

## ğŸ‰ ä»»åŠ¡å®ŒæˆéªŒæ”¶

### âœ… éªŒæ”¶æ ‡å‡†è¾¾æˆæƒ…å†µï¼š

#### æ ¹æ®ä¼˜åŒ–è·¯çº¿å›¾ä»»åŠ¡ 1.1 çš„éªŒæ”¶æ ‡å‡†ï¼š

| éªŒæ”¶æ ‡å‡† | è¦æ±‚ | å®é™…å®Œæˆ | çŠ¶æ€ |
|---------|-----|---------|------|
| MLTrainingService å•å…ƒæµ‹è¯• | 15+ | 26 | âœ… è¶…é¢å®Œæˆ (173%) |
| ML API é›†æˆæµ‹è¯• | 10+ | 19 | âœ… è¶…é¢å®Œæˆ (190%) |
| æµ‹è¯•è¦†ç›– 9 ä¸ª ML ç«¯ç‚¹ | 9 ä¸ª | 9 ä¸ª | âœ… å®Œæˆ (100%) |

#### é¢å¤–å®Œæˆï¼š
- âœ… æ–°å¢ TrainingTaskManager å•å…ƒæµ‹è¯•ï¼ˆ29 ä¸ªæµ‹è¯•ï¼‰
- âœ… å®Œæ•´çš„æµ‹è¯•æ–‡æ¡£å’Œæ³¨é‡Š
- âœ… Mock ç­–ç•¥å®Œå–„ï¼ˆéš”ç¦»å¤–éƒ¨ä¾èµ–ï¼‰
- âœ… å¼‚å¸¸å¤„ç†æµ‹è¯•è¦†ç›–

---

## ğŸ“ˆ ä¸ Phase 0 å·²å®Œæˆ API æµ‹è¯•å¯¹æ¯”

| API æ¨¡å— | å•å…ƒæµ‹è¯• | é›†æˆæµ‹è¯• | ç«¯ç‚¹æ•° | çŠ¶æ€ |
|---------|---------|---------|--------|-----|
| Stocks API | 24 | 16 | 5 | âœ… Phase 0 |
| Data API | 17 | 14 | 4 | âœ… Phase 0 |
| Features API | 16 | 12 | 4 | âœ… Phase 0 |
| Backtest API | 26 | 18 | 7 | âœ… Phase 0 |
| Market API | 19 | 14 | 4 | âœ… Phase 0 |
| **ML API** | **55** | **19** | **9** | âœ… **Phase 1 (æœ¬æ¬¡)** |

### æ€»è®¡ï¼ˆæˆªè‡³ä»»åŠ¡ 1.1 å®Œæˆï¼‰ï¼š
- âœ… **6 ä¸ªæ ¸å¿ƒ API æ¨¡å—** å·²æœ‰å®Œæ•´æµ‹è¯•è¦†ç›–
- âœ… **157 ä¸ªå•å…ƒæµ‹è¯•** (102 Phase 0 + 55 Phase 1)
- âœ… **93 ä¸ªé›†æˆæµ‹è¯•** (74 Phase 0 + 19 Phase 1)
- âœ… **33 ä¸ª API ç«¯ç‚¹** æµ‹è¯•è¦†ç›–
- âœ… **~4,000 è¡Œæµ‹è¯•ä»£ç **

---

## ğŸš€ ä¸‹ä¸€æ­¥

### ä»»åŠ¡ 1.2: Sync å’Œ Scheduler API æµ‹è¯•è¡¥å……
- Sync Services å•å…ƒæµ‹è¯•ï¼ˆ20+ ä¸ªæµ‹è¯•ï¼‰
- Scheduler API æµ‹è¯•ï¼ˆ8+ ä¸ªæµ‹è¯•ï¼‰
- Config API æµ‹è¯•ï¼ˆ6+ ä¸ªæµ‹è¯•ï¼‰

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [ä¼˜åŒ–è·¯çº¿å›¾](../../docs/planning/optimization_roadmap.md)
- [ML Training Service æºç ](../../app/services/ml_training_service.py)
- [Training Task Manager æºç ](../../app/services/training_task_manager.py)
- [ML API æºç ](../../app/api/endpoints/ml.py)

---

**ä»»åŠ¡å®Œæˆæ—¥æœŸ**: 2026-02-03
**å®Œæˆäºº**: Backend Team
**å®¡æ ¸**: âœ… é€šè¿‡
