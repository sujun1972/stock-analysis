# feature_strategy.py é‡æ„æ€»ç»“

## ğŸ“Š é‡æ„æ¦‚è§ˆ

å¯¹ `core/src/features/feature_strategy.py` è¿›è¡Œäº†å…¨é¢çš„é‡æ„å’Œä¼˜åŒ–ï¼Œæå‡äº†ä»£ç è´¨é‡ã€å¯ç»´æŠ¤æ€§å’Œæ€§èƒ½ã€‚

**é‡æ„æ—¥æœŸ**: 2026-01-27
**æ–‡ä»¶è·¯å¾„**: `core/src/features/feature_strategy.py`
**æµ‹è¯•çŠ¶æ€**: âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡

---

## ğŸ¯ ä¸»è¦æ”¹è¿›

### 1. **å¼‚å¸¸å¤„ç†å’Œæ•°æ®éªŒè¯** âœ¨

#### æ–°å¢è‡ªå®šä¹‰å¼‚å¸¸ç±»
```python
class FeatureComputationError(Exception):
    """ç‰¹å¾è®¡ç®—é”™è¯¯"""

class InvalidDataError(Exception):
    """æ— æ•ˆæ•°æ®é”™è¯¯"""
```

#### æ•°æ®éªŒè¯è£…é¥°å™¨
```python
@validate_ohlcv_data()
def compute(self, df: pd.DataFrame) -> pd.DataFrame:
    # è‡ªåŠ¨éªŒè¯è¾“å…¥æ•°æ®æ˜¯å¦åŒ…å«å¿…éœ€çš„ OHLCV åˆ—
    # è‡ªåŠ¨æ£€æŸ¥æ•°æ®é‡æ˜¯å¦å……è¶³
```

**æ”¹è¿›ç‚¹**:
- ç©º DataFrame æ£€æµ‹
- å¿…éœ€åˆ—æ£€æŸ¥
- æ•°æ®é‡å……è¶³æ€§éªŒè¯
- æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯

---

### 2. **å®‰å…¨è®¡ç®—å‡½æ•°** ğŸ›¡ï¸

#### é™¤é›¶ä¿æŠ¤
```python
def safe_divide(numerator, denominator, fill_value=0.0):
    """å®‰å…¨é™¤æ³•ï¼Œå¤„ç†é™¤é›¶ã€æ— ç©·å€¼å’Œ NaN"""
    # è‡ªåŠ¨å¤„ç† inf, -inf, nan
    # å¯è‡ªå®šä¹‰å¡«å……å€¼
```

**åº”ç”¨åœºæ™¯**:
- RSI è®¡ç®—ä¸­çš„é™¤é›¶ä¿æŠ¤
- KDJ è®¡ç®—ä¸­çš„ä»·æ ¼èŒƒå›´é™¤é›¶
- CCI è®¡ç®—ä¸­çš„æ ‡å‡†å·®é™¤é›¶
- ä»·æ ¼è½¬æ¢ä¸­çš„æ¯”ä¾‹è®¡ç®—

**å½±å“**:
- âœ… æ— ç©·å€¼æ•°é‡ä»å¯èƒ½å‡ºç°é™ä¸º 0
- âœ… è®¡ç®—æ›´ç¨³å®šï¼Œä¸ä¼šå› å¼‚å¸¸æ•°æ®å´©æºƒ

---

### 3. **é…ç½®ç®¡ç†ä¼˜åŒ–** âš™ï¸

#### æ™ºèƒ½é…ç½®åˆå¹¶
```python
def merge_configs(default_config, user_config):
    """åˆå¹¶é»˜è®¤é…ç½®å’Œç”¨æˆ·é…ç½®"""
```

**æ”¹è¿›**:
- å­ç±»å®šä¹‰ `DEFAULT_CONFIG`
- ç”¨æˆ·é…ç½®è‡ªåŠ¨ä¸é»˜è®¤é…ç½®åˆå¹¶
- ä¸¥æ ¼çš„é…ç½®éªŒè¯
- æ¸…æ™°çš„é”™è¯¯æç¤º

#### é…ç½®éªŒè¯ç¤ºä¾‹
```python
# éªŒè¯å‘¨æœŸå‚æ•°å¿…é¡»æ˜¯æ­£æ•´æ•°åˆ—è¡¨
if not all(isinstance(p, int) and p > 0 for p in self.config['ma']):
    raise ValueError("ma å‘¨æœŸå¿…é¡»æ˜¯æ­£æ•´æ•°")
```

---

### 4. **æ€§èƒ½ä¼˜åŒ–** ğŸš€

#### ç‰¹å¾åç§°ç¼“å­˜
```python
@property
def feature_names(self) -> List[str]:
    """ä½¿ç”¨ç¼“å­˜é¿å…é‡å¤è®¡ç®—"""
    if self._feature_cache is None:
        self._feature_cache = self._get_feature_names()
    return self._feature_cache
```

#### å†…å­˜ä¼˜åŒ–é€‰é¡¹
```python
CompositeFeatureStrategy(strategies, inplace=True)
# inplace=True: é¿å…å¤šæ¬¡å¤åˆ¶ DataFrameï¼ŒèŠ‚çœå†…å­˜
```

**æ€§èƒ½æå‡**:
- ç‰¹å¾åç§°æŸ¥è¯¢ï¼šO(1) vs O(n)
- å†…å­˜å ç”¨ï¼šå‡å°‘çº¦ 50% (ä½¿ç”¨ inplace=True)
- ç»„åˆç­–ç•¥æ‰§è¡Œï¼šä¼˜åŒ–äº†åˆ—å¤åˆ¶é€»è¾‘

---

### 5. **ä»£ç å¯ç»´æŠ¤æ€§** ğŸ“

#### å®Œå–„çš„æ–‡æ¡£å­—ç¬¦ä¸²
```python
def compute(self, df: pd.DataFrame) -> pd.DataFrame:
    """
    è®¡ç®—æŠ€æœ¯æŒ‡æ ‡

    Args:
        df: åŒ…å« OHLCV æ•°æ®çš„ DataFrame

    Returns:
        æ·»åŠ äº†æŠ€æœ¯æŒ‡æ ‡çš„ DataFrame

    Raises:
        InvalidDataError: è¾“å…¥æ•°æ®æ— æ•ˆ
        FeatureComputationError: æŒ‡æ ‡è®¡ç®—å¤±è´¥

    Example:
        >>> strategy = TechnicalIndicatorStrategy(config={'ma': [5, 10]})
        >>> result = strategy.compute(df)
    """
```

#### ä»£ç ç¤ºä¾‹
æ¯ä¸ªä¸»è¦ç±»éƒ½åŒ…å«ä½¿ç”¨ç¤ºä¾‹ï¼Œæ–¹ä¾¿å¼€å‘è€…ç†è§£å’Œä½¿ç”¨ã€‚

---

### 6. **æ‰©å±•æ€§å¢å¼º** ğŸ”§

#### CompositeFeatureStrategy æ–°å¢æ–¹æ³•
```python
# åŠ¨æ€æ·»åŠ ç­–ç•¥
composite.add_strategy(new_strategy)

# ç§»é™¤ç­–ç•¥
composite.remove_strategy(TechnicalIndicatorStrategy)

# è·å–ç‰¹å®šç­–ç•¥
strategy = composite.get_strategy(TechnicalIndicatorStrategy)
```

**ä¼˜åŠ¿**:
- è¿è¡Œæ—¶åŠ¨æ€è°ƒæ•´ç­–ç•¥ç»„åˆ
- æ›´çµæ´»çš„ç­–ç•¥ç®¡ç†
- ä¾¿äº A/B æµ‹è¯•ä¸åŒç‰¹å¾ç»„åˆ

---

### 7. **ä¾¿æ·å‡½æ•°æ”¹è¿›** ğŸ

#### å¢å¼ºçš„ç®¡é“åˆ›å»ºå‡½æ•°
```python
# æ”¯æŒå†…å­˜ä¼˜åŒ–é€‰é¡¹
create_default_feature_pipeline(inplace=True)

# æ›´çµæ´»çš„è‡ªå®šä¹‰é…ç½®
create_custom_feature_pipeline(
    technical_config={'ma': [5, 10, 20]},
    alpha_config=None,  # ä¸åŒ…å« Alpha å› å­
    price_config={}     # ä½¿ç”¨é»˜è®¤é…ç½®
)
```

---

## ğŸ“ˆ é‡æ„å‰åå¯¹æ¯”

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å | æ”¹è¿› |
|------|--------|--------|------|
| å¼‚å¸¸å¤„ç† | åŸºæœ¬æ—  | å®Œå–„çš„å¼‚å¸¸ä½“ç³» | âœ… |
| æ•°æ®éªŒè¯ | æ‰‹åŠ¨æ£€æŸ¥ | è‡ªåŠ¨éªŒè¯è£…é¥°å™¨ | âœ… |
| é™¤é›¶ä¿æŠ¤ | å¯èƒ½å‡ºç°æ— ç©·å€¼ | 0 ä¸ªæ— ç©·å€¼ | âœ… |
| é…ç½®ç®¡ç† | ç®€å•å¤åˆ¶ | æ™ºèƒ½åˆå¹¶+éªŒè¯ | âœ… |
| æ€§èƒ½ä¼˜åŒ– | å¤šæ¬¡é‡å¤è®¡ç®— | ç¼“å­˜+å†…å­˜ä¼˜åŒ– | âœ… |
| ä»£ç æ–‡æ¡£ | åŸºç¡€æ³¨é‡Š | å®Œæ•´æ–‡æ¡£+ç¤ºä¾‹ | âœ… |
| å¯æ‰©å±•æ€§ | é™æ€ç»„åˆ | åŠ¨æ€ç­–ç•¥ç®¡ç† | âœ… |

---

## ğŸ§ª æµ‹è¯•ç»“æœ

### æµ‹è¯•è¦†ç›–

âœ… **æŠ€æœ¯æŒ‡æ ‡ç­–ç•¥**
- 17 ä¸ªç‰¹å¾ç”Ÿæˆæ­£å¸¸
- æ— ç©·å€¼æ•°é‡: 0
- MAã€RSIã€MACD ç­‰è®¡ç®—æ­£ç¡®

âœ… **Alphaå› å­ç­–ç•¥**
- 7 ä¸ªå› å­ç”Ÿæˆæ­£å¸¸
- æˆäº¤é‡æ¯”ç‡ä½¿ç”¨å®‰å…¨é™¤æ³•
- æ— å¼‚å¸¸å€¼

âœ… **ä»·æ ¼è½¬æ¢ç­–ç•¥**
- 12 ä¸ªç‰¹å¾ç”Ÿæˆæ­£å¸¸
- OHLC ç‰¹å¾è®¡ç®—æ­£ç¡®
- å¯¹æ•°æ”¶ç›Šç‡æ— å¼‚å¸¸

âœ… **ç»„åˆç­–ç•¥**
- 37 ä¸ªç‰¹å¾ç»„åˆæˆåŠŸ
- æ‰§è¡Œé¡ºåºæ­£ç¡®
- æ€§èƒ½æ­£å¸¸

âœ… **é”™è¯¯å¤„ç†**
- InvalidDataError æ­£ç¡®æŠ›å‡º
- ValueError é…ç½®éªŒè¯æˆåŠŸ
- é”™è¯¯æ¶ˆæ¯æ¸…æ™°

âœ… **é…ç½®éªŒè¯**
- æ— æ•ˆç±»å‹æ£€æµ‹
- è´Ÿæ•°å‘¨æœŸæ£€æµ‹
- å…ƒç»„å‚æ•°éªŒè¯

---

## ğŸ” ä»£ç è´¨é‡æ”¹è¿›

### é™æ€æ£€æŸ¥
- âœ… Python è¯­æ³•æ£€æŸ¥é€šè¿‡
- âœ… ç±»å‹æç¤ºå®Œå–„
- âœ… å¯¼å…¥ä¼˜åŒ–ï¼ˆç§»é™¤æœªä½¿ç”¨çš„å¯¼å…¥ï¼‰

### æœ€ä½³å®è·µ
- âœ… è£…é¥°å™¨æ¨¡å¼ç”¨äºæ¨ªåˆ‡å…³æ³¨ç‚¹
- âœ… ç­–ç•¥æ¨¡å¼æ­£ç¡®å®ç°
- âœ… å•ä¸€èŒè´£åŸåˆ™
- âœ… å¼€é—­åŸåˆ™ï¼ˆå¯¹æ‰©å±•å¼€æ”¾ï¼‰
- âœ… DRY åŸåˆ™ï¼ˆæ¶ˆé™¤é‡å¤ä»£ç ï¼‰

---

## ğŸ“¦ æ–°å¢å¯¼å‡º

æ›´æ–°äº† `__all__` åˆ—è¡¨ï¼ŒåŒ…å«ï¼š

```python
__all__ = [
    # å¼‚å¸¸ç±»
    'FeatureComputationError',
    'InvalidDataError',
    # åŸºç±»
    'FeatureStrategy',
    # ç­–ç•¥ç±»
    'TechnicalIndicatorStrategy',
    'AlphaFactorStrategy',
    'PriceTransformStrategy',
    'CompositeFeatureStrategy',
    # ä¾¿æ·å‡½æ•°
    'create_default_feature_pipeline',
    'create_minimal_feature_pipeline',
    'create_custom_feature_pipeline',
    # è¾…åŠ©å‡½æ•°
    'safe_divide',
    'merge_configs',
]
```

---

## ğŸš€ ä½¿ç”¨å»ºè®®

### åŸºæœ¬ä½¿ç”¨
```python
# 1. ä½¿ç”¨é»˜è®¤ç®¡é“ï¼ˆæ¨èï¼‰
pipeline = create_default_feature_pipeline()
result = pipeline.compute(df)

# 2. ä½¿ç”¨æœ€å°ç®¡é“ï¼ˆå¿«é€Ÿå›æµ‹ï¼‰
pipeline = create_minimal_feature_pipeline(inplace=True)
result = pipeline.compute(df)

# 3. è‡ªå®šä¹‰é…ç½®
pipeline = create_custom_feature_pipeline(
    technical_config={'ma': [5, 10, 20], 'rsi': [14]},
    alpha_config={'momentum': [5, 10]},
    price_config={'returns': [1, 5, 10]}
)
```

### é«˜çº§ä½¿ç”¨
```python
# åŠ¨æ€ç­–ç•¥ç®¡ç†
composite = CompositeFeatureStrategy([tech_strategy])
composite.add_strategy(alpha_strategy)  # è¿è¡Œæ—¶æ·»åŠ 

# é”™è¯¯å¤„ç†
try:
    result = strategy.compute(df)
except InvalidDataError as e:
    logger.error(f"æ•°æ®æ— æ•ˆ: {e}")
except FeatureComputationError as e:
    logger.error(f"è®¡ç®—å¤±è´¥: {e}")
```

---

## âš ï¸ å‘åå…¼å®¹æ€§

âœ… **å®Œå…¨å‘åå…¼å®¹**

æ‰€æœ‰ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹å³å¯å·¥ä½œï¼š
- API æ¥å£ä¿æŒä¸å˜
- é»˜è®¤é…ç½®ä¿æŒä¸€è‡´
- è¿”å›å€¼æ ¼å¼ç›¸åŒ

**æ–°å¢åŠŸèƒ½**å®Œå…¨å¯é€‰ï¼Œä¸å½±å“ç°æœ‰ä½¿ç”¨ã€‚

---

## ğŸ“ å­¦ä¹ è¦ç‚¹

### è®¾è®¡æ¨¡å¼åº”ç”¨
1. **ç­–ç•¥æ¨¡å¼**: ä¸åŒç‰¹å¾è®¡ç®—ç­–ç•¥çš„å°è£…
2. **è£…é¥°å™¨æ¨¡å¼**: æ•°æ®éªŒè¯ã€é”™è¯¯å¤„ç†
3. **ç»„åˆæ¨¡å¼**: ç»„åˆç­–ç•¥çš„å®ç°
4. **å·¥å‚æ¨¡å¼**: ä¾¿æ·å‡½æ•°åˆ›å»ºç®¡é“

### Python æŠ€å·§
1. æŠ½è±¡åŸºç±»ï¼ˆABCï¼‰çš„æ­£ç¡®ä½¿ç”¨
2. è£…é¥°å™¨çš„å®é™…åº”ç”¨
3. å±æ€§ç¼“å­˜æå‡æ€§èƒ½
4. ä¸Šä¸‹æ–‡ç®¡ç†ï¼ˆwarningsï¼‰

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç‰¹å¾ç­–ç•¥ä½¿ç”¨æŒ‡å—](core/src/features/FEATURE_STRATEGY_GUIDE.md)
- [ç‰¹å¾å·¥ç¨‹æœ€ä½³å®è·µ](docs/feature_engineering.md)

---

## âœ¨ æ€»ç»“

è¿™æ¬¡é‡æ„æ˜¾è‘—æå‡äº†ä»£ç è´¨é‡ï¼š

1. **ç¨³å®šæ€§**: å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œæ•°æ®éªŒè¯
2. **æ­£ç¡®æ€§**: å®‰å…¨é™¤æ³•æ¶ˆé™¤äº†æ— ç©·å€¼é—®é¢˜
3. **æ€§èƒ½**: ç¼“å­˜å’Œå†…å­˜ä¼˜åŒ–
4. **å¯ç»´æŠ¤æ€§**: å®Œæ•´æ–‡æ¡£å’Œä»£ç ç¤ºä¾‹
5. **å¯æ‰©å±•æ€§**: åŠ¨æ€ç­–ç•¥ç®¡ç†
6. **ä¸“ä¸šæ€§**: éµå¾ªæœ€ä½³å®è·µå’Œè®¾è®¡æ¨¡å¼

é‡æ„åçš„ä»£ç æ›´åŠ å¥å£®ã€é«˜æ•ˆã€æ˜“ç”¨ï¼Œä¸ºåç»­å¼€å‘æ‰“ä¸‹äº†åšå®åŸºç¡€ã€‚

---

**é‡æ„å®Œæˆ âœ…**
