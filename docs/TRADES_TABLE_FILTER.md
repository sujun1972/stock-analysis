# 交易明细表格过滤功能

## 功能概述

为回测结果的交易明细表格添加了多维度过滤功能，支持按股票、交易方向、交易原因筛选数据，方便用户快速定位关键交易记录。

---

## 功能特性

### 1. **股票过滤**
- **显示条件**：当回测涉及多只股票时显示（单股票回测不显示）
- **功能**：下拉选择特定股票代码，只查看该股票的交易记录
- **计数显示**：每个股票选项后显示交易笔数，如 `600031 (19)`
- **默认值**：`全部 (总交易数)`

**示例场景**：
```
回测股票池: ["600031", "000001", "000002"]
总交易: 150笔

过滤器显示:
- 全部 (150)
- 000001 (45)
- 000002 (52)
- 600031 (53)
```

### 2. **交易方向过滤**
- **选项**：
  - `全部`：显示所有交易
  - `买入`：只显示买入记录
  - `卖出`：只显示卖出记录
- **用途**：快速查看入场或离场记录

**示例场景**：
```
选择"卖出" → 查看所有离场交易
- 分析止损/止盈比例
- 检查离场时机是否合理
```

### 3. **交易原因过滤**
- **显示条件**：当存在多种交易原因时显示
- **选项**：自动提取所有交易的原因/触发器
  - 买入原因：`signal`（策略信号）
  - 卖出原因：`stop_loss`（止损）、`take_profit`（止盈）、`trailing_stop`（移动止损）等
- **翻译显示**：原因代码会被翻译为中文显示

**示例场景**：
```
过滤器显示:
- 全部
- 策略信号 (买入)
- 止损 (卖出)
- 止盈 (卖出)

选择"止损" → 只显示因止损离场的交易
```

### 4. **组合过滤**
支持多个过滤条件同时生效：

**示例**：
```
股票: 600031
方向: 卖出
原因: 止损

→ 只显示"600031止损卖出"的交易记录
```

### 5. **重置过滤**
- **显示条件**：当任一过滤器不为"全部"时显示
- **功能**：一键清除所有过滤条件
- **自动重置分页**：清除过滤后回到第1页

---

## UI设计

### 过滤器布局
```
┌─────────────────────────────────────────────────────────────┐
│ 交易明细                                           [分页控件] │
│ 过滤后显示 19 笔交易（共 150 笔），当前第 1-19 笔            │
├─────────────────────────────────────────────────────────────┤
│ 股票: [600031 (19) ▼]  方向: [全部 ▼]  原因: [止损 ▼]  [重置过滤] │
├─────────────────────────────────────────────────────────────┤
│ 表格内容...                                                   │
└─────────────────────────────────────────────────────────────┘
```

### 样式特点
- **自适应布局**：过滤器自动换行，适配不同屏幕宽度
- **暗色主题支持**：过滤器下拉框在暗色模式下有正确的颜色
- **焦点高亮**：选中过滤器时显示蓝色边框
- **计数显示**：实时显示过滤结果数量

---

## 技术实现

### 文件位置
`frontend/src/components/backtest/BacktestResultView.tsx`

### 核心代码

#### 1. 状态管理
```typescript
const [selectedStock, setSelectedStock] = useState<string>('all')
const [selectedDirection, setSelectedDirection] = useState<string>('all')
const [selectedReason, setSelectedReason] = useState<string>('all')
```

#### 2. 提取过滤选项
```typescript
// 提取所有唯一的股票代码
const allStocks = Array.from(
  new Set(
    result.trades?.map((t: any) => t.stock_code || t.code || t.symbol)
      .filter(Boolean) || []
  )
).sort()

// 提取所有唯一的交易原因
const allReasons = Array.from(
  new Set(
    result.trades?.map((t: any) => {
      const direction = t.direction || t.action
      if (direction === 'buy') {
        return t.entry_reason
      } else {
        return t.exit_trigger || t.exit_reason
      }
    }).filter(Boolean) || []
  )
).sort()
```

#### 3. 应用过滤逻辑
```typescript
const filteredTrades = (result.trades || []).filter((trade: any) => {
  const stockCode = trade.stock_code || trade.code || trade.symbol
  const direction = trade.direction || trade.action

  // 股票过滤
  if (selectedStock !== 'all' && stockCode !== selectedStock) {
    return false
  }

  // 方向过滤
  if (selectedDirection !== 'all' && direction !== selectedDirection) {
    return false
  }

  // 原因过滤
  if (selectedReason !== 'all') {
    const reason = direction === 'buy'
      ? trade.entry_reason
      : (trade.exit_trigger || trade.exit_reason)
    if (reason !== selectedReason) {
      return false
    }
  }

  return true
})
```

#### 4. 分页重置
```typescript
const resetPage = () => setTradesPage(1)

// 在每个过滤器的onChange中调用
onChange={(e) => {
  setSelectedStock(e.target.value)
  resetPage()  // ← 重置到第1页
}}
```

---

## 使用场景

### 场景1：分析特定股票的交易表现
```
问题：回测了50只股票，想单独分析"600031"的交易情况

操作：
1. 股票过滤器选择 "600031"
2. 查看该股票的所有买入/卖出记录
3. 分析盈亏情况
```

### 场景2：检查止损策略效果
```
问题：想知道有多少次交易是因为止损离场

操作：
1. 方向过滤器选择 "卖出"
2. 原因过滤器选择 "止损"
3. 查看所有止损记录
4. 分析止损价格和持仓时长
```

### 场景3：分析入场时机
```
问题：想查看所有策略信号触发的买入点

操作：
1. 方向过滤器选择 "买入"
2. 原因过滤器选择 "策略信号"
3. 查看所有入场记录
4. 对比买入价格和后续走势
```

### 场景4：组合分析
```
问题：想查看"600031"的所有止盈离场记录

操作：
1. 股票过滤器选择 "600031"
2. 方向过滤器选择 "卖出"
3. 原因过滤器选择 "止盈"
4. 结果：只显示该股票的止盈记录
```

---

## 数据统计示例

### 过滤前
```
交易明细
共 150 笔交易，当前显示第 1-20 笔
```

### 过滤后
```
交易明细
过滤后显示 19 笔交易（共 150 笔），当前第 1-19 笔

过滤条件:
- 股票: 600031 (53笔)
- 方向: 卖出
- 原因: 止损

→ 实际显示: 19 笔（600031的止损卖出）
```

---

## 性能优化

### 1. 客户端过滤
- 所有过滤在前端完成，无需额外请求后端
- 过滤后的数据立即响应

### 2. React Memo优化
```typescript
export const TradesTable = memo(function TradesTable({ result }: { result: any }) {
  // 组件被memo包装，避免不必要的重渲染
})
```

### 3. 智能显示
- 单股票回测不显示股票过滤器
- 单一原因不显示原因过滤器
- 减少UI复杂度

---

## 未来增强

### 可能的扩展功能
1. **日期范围过滤**：选择特定时间段的交易
2. **金额过滤**：筛选大额交易（如 > 10万）
3. **盈亏过滤**：只显示盈利/亏损的交易
4. **导出功能**：导出过滤后的交易记录为CSV
5. **高级搜索**：支持正则表达式或多条件组合

### 可能的UI改进
1. **过滤器折叠**：默认隐藏，点击"高级过滤"展开
2. **快捷标签**：预设常用过滤组合（如"所有止损"）
3. **统计摘要**：过滤结果的统计信息（总盈亏、平均持仓等）

---

## 总结

交易明细表格过滤功能提供了灵活的数据分析能力，帮助用户：
- ✅ 快速定位关键交易
- ✅ 分析特定股票表现
- ✅ 评估离场策略效果
- ✅ 优化交易决策

通过组合不同的过滤条件，用户可以从多个维度深入分析回测结果，为策略优化提供数据支撑。
