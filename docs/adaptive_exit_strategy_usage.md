# è‡ªé€‚åº”ç¦»åœºç­–ç•¥ä½¿ç”¨æŒ‡å—

> æ–‡ä»¶: `core/src/ml/adaptive_exit_strategy.py`
> ç‰ˆæœ¬: v1.0.0
> åˆ›å»ºæ—¶é—´: 2026-02-13

## ğŸ“‹ ç­–ç•¥æ¦‚è¿°

**AdaptiveExitStrategy** æ˜¯ä¸€ä¸ªæ™ºèƒ½çš„ç¦»åœºç­–ç•¥ï¼Œå®ƒä¼šæ ¹æ®ä»¥ä¸‹å› ç´ åŠ¨æ€è°ƒæ•´æ­¢ç›ˆæ­¢æŸå‚æ•°ï¼š

1. **å¸‚åœºæ³¢åŠ¨æ€§** - ä½æ³¢åŠ¨æ—¶æ›´ä¸¥æ ¼ï¼Œé«˜æ³¢åŠ¨æ—¶æ›´å®½æ¾
2. **æŒä»“æ—¶é•¿** - é•¿æœŸæŒä»“ä¼šè°ƒæ•´å‚æ•°é¿å…è¿‡æ—©ç¦»åœº
3. **å½“å‰ç›ˆäº** - ç›ˆåˆ©æ—¶ä¼šå¯ç”¨ç›ˆåˆ©ä¿æŠ¤æœºåˆ¶

---

## ğŸ¯ æ ¸å¿ƒç‰¹ç‚¹

### 1. åŠ¨æ€å‚æ•°è°ƒæ•´

| å¸‚åœºç¯å¢ƒ | æ³¢åŠ¨æ€§ | æ­¢æŸè°ƒæ•´ | æ­¢ç›ˆè°ƒæ•´ | è¯´æ˜ |
|---------|--------|---------|---------|------|
| **ä½æ³¢åŠ¨** | < 30% | -20% (æ›´ä¸¥æ ¼) | -30% (æ›´å¿«) | é¿å…éœ‡è¡è¢«å¥— |
| **ä¸­ç­‰æ³¢åŠ¨** | 30%-70% | åŸºå‡†å‚æ•° | åŸºå‡†å‚æ•° | æ­£å¸¸ç­–ç•¥ |
| **é«˜æ³¢åŠ¨** | > 70% | +50% (æ›´å®½æ¾) | +50% (æ›´é«˜) | ç»™è¶³ä¸Šæ¶¨ç©ºé—´ |

### 2. æŒä»“æ—¶é•¿ä¿æŠ¤

```
æŒä»“ â‰¤ 15å¤©: ä½¿ç”¨åŸºå‡†å‚æ•°
æŒä»“ > 15å¤©:
  â”œâ”€ æ¯5å¤©: æ­¢ç›ˆ -10%ï¼ˆæ”¶ç´§ï¼‰
  â””â”€ æ¯5å¤©: æ­¢æŸ +5%ï¼ˆæ”¾å®½ï¼‰
```

### 3. ç›ˆåˆ©ä¿æŠ¤æœºåˆ¶

```
å½“å‰ç›ˆåˆ© > 5%:
  â””â”€ æ­¢æŸè°ƒæ•´ä¸º: min(åŸæ­¢æŸ, å½“å‰ç›ˆåˆ© Ã— 30%)
     ç›®çš„: ä¿æŠ¤30%çš„å·²å®ç°åˆ©æ¶¦
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸºç¡€ç”¨æ³•

```python
from src.ml.adaptive_exit_strategy import AdaptiveExitStrategy
from src.ml.exit_strategy import CompositeExitManager

# åˆ›å»ºè‡ªé€‚åº”ç¦»åœºç­–ç•¥
adaptive_exit = AdaptiveExitStrategy(
    base_stop_loss=0.08,      # åŸºå‡†æ­¢æŸ 8%
    base_take_profit=0.15,    # åŸºå‡†æ­¢ç›ˆ 15%
    volatility_window=20,     # æ³¢åŠ¨æ€§è®¡ç®—çª—å£ 20å¤©
    priority=9                # ä¼˜å…ˆçº§
)

# ç»„åˆåˆ°ç¦»åœºç®¡ç†å™¨
exit_manager = CompositeExitManager(
    exit_strategies=[adaptive_exit],
    enable_reverse_entry=True,
    enable_risk_control=True
)
```

### é…åˆMLå›æµ‹

```python
from src.backtest.backtest_engine import BacktestEngine
from src.ml.ml_entry import MLEntry
from src.ml.adaptive_exit_strategy import create_adaptive_exit_manager

# å…¥åœºç­–ç•¥
ml_entry = MLEntry(
    model_path='models/ml_model.pkl',
    confidence_threshold=0.7,
    top_long=10
)

# è‡ªé€‚åº”ç¦»åœºç®¡ç†å™¨
exit_manager = create_adaptive_exit_manager()

# å›æµ‹
engine = BacktestEngine(initial_capital=1000000)
result = engine.backtest_ml_strategy(
    ml_entry=ml_entry,
    stock_pool=['600000.SH', '000001.SZ', ...],
    market_data=market_data,
    start_date='2024-01-01',
    end_date='2024-12-31',
    rebalance_freq='W',
    exit_manager=exit_manager  # ä½¿ç”¨è‡ªé€‚åº”ç¦»åœº
)

# æŸ¥çœ‹ç¦»åœºç»Ÿè®¡
print(result.data['metrics']['exit_stats'])
# {'strategy': 25, 'reverse_entry': 8, 'risk_control': 42}
```

---

## ğŸ“Š å‚æ•°è¯´æ˜

### åˆå§‹åŒ–å‚æ•°

```python
AdaptiveExitStrategy(
    base_stop_loss=0.08,       # åŸºå‡†æ­¢æŸæ¯”ä¾‹ï¼ˆ8%ï¼‰
    base_take_profit=0.15,     # åŸºå‡†æ­¢ç›ˆæ¯”ä¾‹ï¼ˆ15%ï¼‰
    volatility_window=20,      # æ³¢åŠ¨æ€§è®¡ç®—çª—å£ï¼ˆ20å¤©ï¼‰
    priority=9                 # ä¼˜å…ˆçº§ï¼ˆ9=é£æ§çº§åˆ«ï¼‰
)
```

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `base_stop_loss` | float | 0.08 | åŸºå‡†æ­¢æŸæ¯”ä¾‹ï¼Œä¼šæ ¹æ®å¸‚åœºç¯å¢ƒåŠ¨æ€è°ƒæ•´ |
| `base_take_profit` | float | 0.15 | åŸºå‡†æ­¢ç›ˆæ¯”ä¾‹ï¼Œä¼šæ ¹æ®å¸‚åœºç¯å¢ƒåŠ¨æ€è°ƒæ•´ |
| `volatility_window` | int | 20 | è®¡ç®—æ³¢åŠ¨æ€§çš„å†å²æ•°æ®çª—å£ï¼ˆå¤©ï¼‰ |
| `priority` | int | 9 | ç¦»åœºä¿¡å·ä¼˜å…ˆçº§ï¼ˆ1-11ï¼Œè¶Šå¤§è¶Šä¼˜å…ˆï¼‰ |

### è°ƒæ•´èŒƒå›´

å®é™…æ‰§è¡Œæ—¶çš„å‚æ•°èŒƒå›´ï¼ˆç»è¿‡è°ƒæ•´åï¼‰ï¼š

- **æ­¢æŸèŒƒå›´**: 2% - 25%
- **æ­¢ç›ˆèŒƒå›´**: 5% - 50%

---

## ğŸ¨ è°ƒæ•´é€»è¾‘ç¤ºä¾‹

### ç¤ºä¾‹1: ä½æ³¢åŠ¨ + çŸ­æœŸæŒä»“ + å°ç›ˆåˆ©

**è¾“å…¥**:
- æ³¢åŠ¨æ€§: 0.25 (ä½æ³¢åŠ¨)
- æŒä»“å¤©æ•°: 5å¤©
- å½“å‰ç›ˆäº: +3%

**è°ƒæ•´è¿‡ç¨‹**:
```
1. åŸºå‡†å‚æ•°: æ­¢æŸ=8%, æ­¢ç›ˆ=15%
2. ä½æ³¢åŠ¨è°ƒæ•´: æ­¢æŸ=8%Ã—0.8=6.4%, æ­¢ç›ˆ=15%Ã—0.7=10.5%
3. æŒä»“å¤©æ•°: æ— è°ƒæ•´ï¼ˆâ‰¤15å¤©ï¼‰
4. ç›ˆåˆ©ä¿æŠ¤: æ— è°ƒæ•´ï¼ˆ<5%ï¼‰
```

**æœ€ç»ˆå‚æ•°**: æ­¢æŸ=6.4%, æ­¢ç›ˆ=10.5%

### ç¤ºä¾‹2: é«˜æ³¢åŠ¨ + é•¿æœŸæŒä»“ + å¤§ç›ˆåˆ©

**è¾“å…¥**:
- æ³¢åŠ¨æ€§: 0.85 (é«˜æ³¢åŠ¨)
- æŒä»“å¤©æ•°: 25å¤©
- å½“å‰ç›ˆäº: +12%

**è°ƒæ•´è¿‡ç¨‹**:
```
1. åŸºå‡†å‚æ•°: æ­¢æŸ=8%, æ­¢ç›ˆ=15%
2. é«˜æ³¢åŠ¨è°ƒæ•´: æ­¢æŸ=8%Ã—1.5=12%, æ­¢ç›ˆ=15%Ã—1.5=22.5%
3. æŒä»“å¤©æ•°è°ƒæ•´:
   - è¶…è¿‡15å¤©: 10å¤©
   - æ­¢ç›ˆ: 22.5% Ã— (1 - 10/5Ã—0.1) = 22.5% Ã— 0.8 = 18%
   - æ­¢æŸ: 12% Ã— (1 + 10/5Ã—0.05) = 12% Ã— 1.1 = 13.2%
4. ç›ˆåˆ©ä¿æŠ¤:
   - å½“å‰ç›ˆåˆ©12% > 5%
   - ä¿æŠ¤æ­¢æŸ: min(13.2%, 12%Ã—0.3) = min(13.2%, 3.6%) = 3.6%
```

**æœ€ç»ˆå‚æ•°**: æ­¢æŸ=3.6% (ä¿æŠ¤åˆ©æ¶¦), æ­¢ç›ˆ=18%

### ç¤ºä¾‹3: ä¸­ç­‰æ³¢åŠ¨ + äºæŸ

**è¾“å…¥**:
- æ³¢åŠ¨æ€§: 0.50 (ä¸­ç­‰æ³¢åŠ¨)
- æŒä»“å¤©æ•°: 8å¤©
- å½“å‰ç›ˆäº: -6%

**è°ƒæ•´è¿‡ç¨‹**:
```
1. åŸºå‡†å‚æ•°: æ­¢æŸ=8%, æ­¢ç›ˆ=15%
2. ä¸­ç­‰æ³¢åŠ¨: æ— è°ƒæ•´
3. æŒä»“å¤©æ•°: æ— è°ƒæ•´ï¼ˆâ‰¤15å¤©ï¼‰
4. ç›ˆåˆ©ä¿æŠ¤: æ— è°ƒæ•´ï¼ˆäºæŸï¼‰
```

**æœ€ç»ˆå‚æ•°**: æ­¢æŸ=8%, æ­¢ç›ˆ=15%

---

## ğŸ”§ é«˜çº§ç”¨æ³•

### ç»„åˆå¤šä¸ªç¦»åœºç­–ç•¥

```python
from src.ml.exit_strategy import (
    CompositeExitManager,
    StopLossExitStrategy,
    HoldingPeriodExitStrategy
)
from src.ml.adaptive_exit_strategy import AdaptiveExitStrategy

exit_manager = CompositeExitManager(
    exit_strategies=[
        # è‡ªé€‚åº”ç­–ç•¥ï¼ˆä¼˜å…ˆçº§9ï¼‰
        AdaptiveExitStrategy(
            base_stop_loss=0.08,
            base_take_profit=0.15,
            priority=9
        ),

        # å…œåº•ç¡¬æ­¢æŸï¼ˆä¼˜å…ˆçº§10ï¼Œæ›´é«˜ï¼‰
        StopLossExitStrategy(
            stop_loss_pct=0.15,  # 15%ç¡¬æ­¢æŸ
            priority=10
        ),

        # æœ€å¤§æŒä»“æœŸï¼ˆä¼˜å…ˆçº§3ï¼‰
        HoldingPeriodExitStrategy(
            max_holding_days=60,
            priority=3
        )
    ],
    enable_reverse_entry=True,
    enable_risk_control=True
)
```

**ä¼˜å…ˆçº§è¯´æ˜**:
- ç¡¬æ­¢æŸ(10) > è‡ªé€‚åº”ç­–ç•¥(9) > æŒä»“æœŸ(3)
- å½“äºæŸè¾¾åˆ°15%æ—¶ï¼Œç¡¬æ­¢æŸä¼šå¼ºåˆ¶ç¦»åœºï¼ˆä¸ç®¡è‡ªé€‚åº”ç­–ç•¥å¦‚ä½•è°ƒæ•´ï¼‰

### è‡ªå®šä¹‰æ³¢åŠ¨æ€§è®¡ç®—

```python
class CustomAdaptiveExit(AdaptiveExitStrategy):
    """ä½¿ç”¨è‡ªå®šä¹‰æ³¢åŠ¨æ€§è®¡ç®—çš„ç¦»åœºç­–ç•¥"""

    def _calculate_volatility(self, stock_code, current_price, market_data):
        # è‡ªå®šä¹‰æ³¢åŠ¨æ€§è®¡ç®—é€»è¾‘
        # ä¾‹å¦‚ï¼šä½¿ç”¨GARCHæ¨¡å‹ã€Realized Volatilityç­‰

        if market_data is None:
            return 0.5

        # ä½ çš„è‡ªå®šä¹‰é€»è¾‘
        stock_data = market_data[market_data['stock_code'] == stock_code]

        # ... è®¡ç®— volatility

        return volatility
```

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### å›æµ‹å¯¹æ¯”ï¼ˆç¤ºä¾‹æ•°æ®ï¼‰

| ç­–ç•¥é…ç½® | å¹´åŒ–æ”¶ç›Š | æœ€å¤§å›æ’¤ | å¤æ™®æ¯”ç‡ | èƒœç‡ |
|---------|---------|---------|---------|------|
| æ— ç¦»åœºç­–ç•¥ | 12.5% | -18.3% | 0.68 | 52% |
| å›ºå®šæ­¢æŸæ­¢ç›ˆ | 14.2% | -12.1% | 0.91 | 55% |
| **è‡ªé€‚åº”ç¦»åœº** | **16.8%** | **-9.7%** | **1.15** | **58%** |

**ä¼˜åŠ¿**:
- âœ… åœ¨é«˜æ³¢åŠ¨å¸‚åœºä¸­é¿å…è¿‡æ—©æ­¢æŸ
- âœ… åœ¨ä½æ³¢åŠ¨å¸‚åœºä¸­å¿«é€Ÿé”å®šåˆ©æ¶¦
- âœ… é•¿æœŸæŒä»“æ—¶çš„æ™ºèƒ½è°ƒæ•´
- âœ… ç›ˆåˆ©ä¿æŠ¤æœºåˆ¶å‡å°‘å›æ’¤

---

## ğŸ› æ³¨æ„äº‹é¡¹

### 1. æ•°æ®ä¾èµ–

è‡ªé€‚åº”ç­–ç•¥**éœ€è¦å†å²å¸‚åœºæ•°æ®**æ¥è®¡ç®—æ³¢åŠ¨æ€§ï¼š

```python
# âœ… æ­£ç¡®ï¼šæä¾›å¸‚åœºæ•°æ®
signal = strategy.should_exit(
    position=position,
    current_price=current_price,
    current_date=current_date,
    market_data=market_data  # å¿…é¡»æä¾›
)

# âš ï¸ ç®€åŒ–æ¨¡å¼ï¼šæ— å¸‚åœºæ•°æ®ï¼ˆä½¿ç”¨é»˜è®¤ä¸­ç­‰æ³¢åŠ¨0.5ï¼‰
signal = strategy.should_exit(
    position=position,
    current_price=current_price,
    current_date=current_date,
    market_data=None  # å°†å‡è®¾ä¸­ç­‰æ³¢åŠ¨
)
```

### 2. æ³¢åŠ¨æ€§çª—å£

- çª—å£å¤ªå°ï¼ˆ<10å¤©ï¼‰ï¼šæ³¢åŠ¨æ€§ä¸ç¨³å®š
- çª—å£å¤ªå¤§ï¼ˆ>40å¤©ï¼‰ï¼šååº”è¿Ÿé’
- **æ¨è**: 20å¤©ï¼ˆé»˜è®¤å€¼ï¼‰

### 3. å‚æ•°èŒƒå›´é™åˆ¶

ä¸ºé¿å…æç«¯æƒ…å†µï¼Œç­–ç•¥ä¼šå¼ºåˆ¶é™åˆ¶å‚æ•°èŒƒå›´ï¼š

```python
# å³ä½¿è°ƒæ•´åè¶…å‡ºèŒƒå›´ï¼Œä¹Ÿä¼šè¢«æˆªæ–­
æ­¢æŸèŒƒå›´: [2%, 25%]
æ­¢ç›ˆèŒƒå›´: [5%, 50%]
```

---

## ğŸ“š ä¸å…¶ä»–ç¦»åœºç­–ç•¥å¯¹æ¯”

| ç‰¹æ€§ | å›ºå®šæ­¢æŸæ­¢ç›ˆ | ç§»åŠ¨æ­¢æŸ | **è‡ªé€‚åº”ç­–ç•¥** |
|------|------------|---------|--------------|
| å‚æ•°è°ƒæ•´ | âŒ å›ºå®š | âŒ å›ºå®š | âœ… åŠ¨æ€è°ƒæ•´ |
| å¸‚åœºç¯å¢ƒé€‚åº” | âŒ | âŒ | âœ… |
| ç›ˆåˆ©ä¿æŠ¤ | âŒ | âœ… | âœ… |
| æŒä»“æ—¶é•¿è€ƒè™‘ | âŒ | âŒ | âœ… |
| å¤æ‚åº¦ | ä½ | ä¸­ | é«˜ |
| é€‚ç”¨åœºæ™¯ | ç¨³å®šå¸‚åœº | è¶‹åŠ¿å¸‚åœº | **æ‰€æœ‰å¸‚åœº** |

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. å‚æ•°é€‰æ‹©

```python
# ä¿å®ˆå‹ï¼ˆé€‚åˆæ–°æ‰‹ï¼‰
AdaptiveExitStrategy(
    base_stop_loss=0.05,  # 5%æ­¢æŸ
    base_take_profit=0.10,  # 10%æ­¢ç›ˆ
    volatility_window=30
)

# å¹³è¡¡å‹ï¼ˆæ¨èï¼‰
AdaptiveExitStrategy(
    base_stop_loss=0.08,  # 8%æ­¢æŸ
    base_take_profit=0.15,  # 15%æ­¢ç›ˆ
    volatility_window=20
)

# æ¿€è¿›å‹ï¼ˆé«˜é£é™©ï¼‰
AdaptiveExitStrategy(
    base_stop_loss=0.12,  # 12%æ­¢æŸ
    base_take_profit=0.25,  # 25%æ­¢ç›ˆ
    volatility_window=15
)
```

### 2. å›æµ‹éªŒè¯

```python
# å¯¹æ¯”æµ‹è¯•
from src.ml.exit_strategy import create_default_exit_manager
from src.ml.adaptive_exit_strategy import create_adaptive_exit_manager

# æµ‹è¯•1ï¼šé»˜è®¤ç¦»åœº
result1 = engine.backtest_ml_strategy(..., exit_manager=create_default_exit_manager())

# æµ‹è¯•2ï¼šè‡ªé€‚åº”ç¦»åœº
result2 = engine.backtest_ml_strategy(..., exit_manager=create_adaptive_exit_manager())

# å¯¹æ¯”æŒ‡æ ‡
print(f"é»˜è®¤: æ”¶ç›Š={result1.data['metrics']['total_return']:.2%}")
print(f"è‡ªé€‚åº”: æ”¶ç›Š={result2.data['metrics']['total_return']:.2%}")
```

---

## ğŸ“ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæœ‰æ—¶å€™ä¸ä¼šè§¦å‘ç¦»åœºï¼Ÿ

**A**: è‡ªé€‚åº”ç­–ç•¥ä¼šæ ¹æ®å¸‚åœºç¯å¢ƒè°ƒæ•´å‚æ•°ã€‚åœ¨é«˜æ³¢åŠ¨å¸‚åœºä¸­ï¼Œæ­¢æŸä¼šè¢«æ”¾å®½ï¼Œå¯èƒ½å¯¼è‡´çœ‹èµ·æ¥"åº”è¯¥æ­¢æŸ"çš„æƒ…å†µæ²¡æœ‰è§¦å‘ã€‚è¿™æ˜¯ç­–ç•¥çš„è®¾è®¡ç‰¹æ€§ï¼Œç›®çš„æ˜¯é¿å…åœ¨éœ‡è¡å¸‚åœºä¸­è¢«é¢‘ç¹æ­¢æŸã€‚

### Q2: å¦‚ä½•æŸ¥çœ‹å®é™…ä½¿ç”¨çš„æ­¢æŸæ­¢ç›ˆå‚æ•°ï¼Ÿ

**A**: ç¦»åœºä¿¡å·çš„metadataä¸­åŒ…å«äº†è°ƒæ•´ä¿¡æ¯ï¼š

```python
if signal:
    print(signal.metadata)
    # {
    #   'adjusted_stop_loss': 0.12,  # å®é™…ä½¿ç”¨çš„æ­¢æŸ
    #   'adjustment_reason': 'é«˜æ³¢åŠ¨ç¯å¢ƒ, æŒä»“25å¤©'
    # }
```

### Q3: å¯ä»¥ç¦ç”¨æŸä¸ªè°ƒæ•´é€»è¾‘å—ï¼Ÿ

**A**: å¯ä»¥é€šè¿‡ç»§æ‰¿ç±»å¹¶é‡å†™ `_adjust_parameters` æ–¹æ³•æ¥è‡ªå®šä¹‰è°ƒæ•´é€»è¾‘ã€‚

---

## ğŸ”— ç›¸å…³èµ„æº

- [ç¦»åœºç­–ç•¥æ ¸å¿ƒä»£ç ](../core/src/ml/exit_strategy.py)
- [è‡ªé€‚åº”ç¦»åœºç­–ç•¥æºç ](../core/src/ml/adaptive_exit_strategy.py)
- [ç¦»åœºç­–ç•¥é›†æˆæ–‡æ¡£](./exit_strategy_integration.md)
- [MLå›æµ‹å¼•æ“](../core/src/backtest/backtest_engine.py)

---

## âœ… æ€»ç»“

**AdaptiveExitStrategy** é€‚åˆ:
- âœ… éœ€è¦åœ¨ä¸åŒå¸‚åœºç¯å¢ƒä¸‹çµæ´»åº”å¯¹
- âœ… å¸Œæœ›å‡å°‘éœ‡è¡å¸‚åœºä¸­çš„å‡çªç ´æ­¢æŸ
- âœ… æƒ³è¦è‡ªåŠ¨ä¿æŠ¤å·²å®ç°åˆ©æ¶¦
- âœ… è¿½æ±‚æ›´é«˜çš„é£é™©è°ƒæ•´æ”¶ç›Šï¼ˆå¤æ™®æ¯”ç‡ï¼‰

**ä¸é€‚åˆ**:
- âŒ ç®€å•å›ºå®šçš„æ­¢ç›ˆæ­¢æŸå³å¯æ»¡è¶³éœ€æ±‚
- âŒ ä¸å¸Œæœ›ç­–ç•¥å‚æ•°é¢‘ç¹å˜åŒ–
- âŒ æ— æ³•æä¾›è¶³å¤Ÿçš„å†å²æ•°æ®è®¡ç®—æ³¢åŠ¨æ€§
